<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TRUST TAP • CRYPTO WALLET GAME</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Твій оригінальний дизайн без жодних змін */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none; 
        }

        body {
            background: #030712;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100dvh;
            overflow-x: hidden;
            padding: 0; 
        }

        .game-container {
            max-width: 480px;
            width: 100%;
            background: linear-gradient(145deg, #0f1a2f, #030a18);
            border-radius: 0; 
            padding: calc(1.5rem + env(safe-area-inset-top, 20px)) 1rem 3rem 1rem; 
            min-height: 100dvh;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.9), 0 0 0 1px #1e3a5f inset;
            color: #ffffff;
            position: relative;
            overflow: hidden;
        }

        @media (min-width: 480px) {
            body { padding: 1rem; align-items: center; }
            .game-container { border-radius: 3rem 3rem 2rem 2rem; min-height: 90vh; padding: 2rem 1.5rem 2rem 1.5rem; }
        }

        .handwritten-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.3; }
        .handwritten-bg span { 
            position: absolute; font-size: 1.2rem; font-weight: 300; color: #3b82f6; 
            font-family: 'Caveat', cursive; transform: rotate(calc(var(--r) * 1deg)); 
            animation: floatT 8s infinite alternate; animation-delay: calc(var(--d) * -1s); 
            text-shadow: 0 0 5px #3b82f6; opacity: 0.6; pointer-events: none;
            will-change: transform, opacity;
        }
        @keyframes floatT { 0% { transform: translateY(0) rotate(calc(var(--r) * 1deg)) scale(1); opacity: 0.4; } 50% { transform: translateY(-15px) rotate(calc(var(--r) * 1deg)) scale(1.1); opacity: 0.8; } 100% { transform: translateY(15px) rotate(calc(var(--r) * 1deg)) scale(0.9); opacity: 0.5; } }

        .game-container::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, transparent 30%, rgba(3, 7, 18, 0.7) 90%); pointer-events: none; z-index: 0; }

        .top-bar, .top-ref-bar, .feature-card, .tasks-section, .upgrade-section {
            background: rgba(20, 40, 70, 0.55); 
            border: 1px solid rgba(59, 130, 246, 0.2);
            position: relative;
            z-index: 2;
        }

        .top-bar { 
            display: flex; justify-content: center; align-items: center; 
            padding: 0.8rem 1.2rem; 
            border-radius: 2.5rem; 
            margin-bottom: 2rem; 
            box-shadow: 0 5px 0 rgba(10, 26, 47, 0.6), 0 8px 15px rgba(0, 0, 0, 0.3); 
            width: max-content; min-width: 60%; 
            margin-left: auto; margin-right: auto; 
        }
        
        .balance-box { 
            display: flex; 
            align-items: center; 
            gap: 2px; 
        }
        .usdt-icon { 
            width: 26px; 
            height: 26px; 
            object-fit: contain; 
            display: block;
        }
        .usdt-text { 
            font-size: 1rem; 
            font-weight: 600; 
            color: #ffffff; 
            text-shadow: 0 0 8px #3b82f6; 
            margin-right: 6px; 
        }
        .balance-amount { 
            font-size: 0.9rem; 
            font-weight: 600; 
            color: #ffffff; 
            text-shadow: 0 0 8px #3b82f6; 
            white-space: nowrap;
        }
        .balance-amount::after { content: ' USDT'; color: #aaccff; font-size: 0.7rem; margin-left: 2px; }

        .energy-panel { 
            background: rgba(10, 20, 35, 0.6); 
            border-radius: 2rem; 
            padding: 0.4rem 0.8rem; 
            margin: 0 auto 3rem auto; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.05); 
            backdrop-filter: blur(5px);
            width: 250px; 
            position: relative;
            z-index: 2;
        }
        
        .energy-left { display: flex; align-items: center; gap: 0.3rem; }
        .bolt { font-size: 0.8rem; color: #f5c45e; filter: drop-shadow(0 0 3px rgba(245, 196, 94, 0.5)); } 
        .energy-count { font-weight: 700; font-size: 0.8rem; color: #ffffff; text-shadow: 0 0 5px rgba(255,255,255,0.3); min-width: 35px; }
        
        .energy-bar-bg { flex-grow: 1; height: 6px; background: rgba(0, 0, 0, 0.6); border-radius: 10px; overflow: hidden; margin: 0 8px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.8); }
        .energy-bar-fill { height: 100%; width: 80%; background: linear-gradient(90deg, #3b82f6, #aaccff, #ffffff); border-radius: 10px; box-shadow: 0 0 8px #aaccff; transition: width 0.1s cubic-bezier(0.4, 0, 0.2, 1); }
        .regen-tip { color: rgba(170, 204, 255, 0.8); font-size: 0.65rem; white-space: nowrap; font-weight: 500; }

        .tap-zone { display: flex; justify-content: center; margin: 0 0 1.5rem 0; cursor: pointer; position: relative; z-index: 5; touch-action: none; }

        .big-coin { 
            width: 250px; height: 250px; 
            background: radial-gradient(circle at 30% 30%, #2b6ed7, #0a2a6a, #031030); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; 
            transition: transform 0.05s ease-out; border: 2px solid rgba(255, 255, 255, 0.4); 
            box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.8), 0 0 0 2px rgba(59, 130, 246, 0.3) inset, 0 0 40px rgba(59, 130, 246, 0.5); 
            animation: modernFloat 5s infinite ease-in-out; 
        }
        
        .big-coin::after { content: ''; position: absolute; inset: -15px; border-radius: 50%; background: radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.6), transparent 70%); z-index: -1; animation: pulseGlow 2.5s infinite alternate; pointer-events: none; }
        @keyframes pulseGlow { 0% { opacity: 0.5; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1.05); } }
        .big-coin::before { content: ''; position: absolute; inset: 10px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.1) 60%, transparent 80%); border: 1px solid rgba(255, 255, 255, 0.4); z-index: 1; pointer-events: none; }
        @keyframes modernFloat { 0% { transform: translateY(0px); } 50% { transform: translateY(-8px); } 100% { transform: translateY(0px); } }
        
        .big-coin.pressed { transform: scale(0.92) !important; box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.9), 0 0 0 3px rgba(59, 130, 246, 0.8) inset, 0 0 70px #3b82f6, 0 0 120px rgba(59, 130, 246, 0.9) !important; }
        .trust-logo { position: relative; z-index: 10; width: 140px; height: 140px; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .letter-t { font-size: 8.5rem; font-weight: 900; color: #ffffff; text-shadow: 0 0 30px rgba(255, 255, 255, 0.9), 0 0 60px #3b82f6; line-height: 1; animation: letterSuperPulse 2.5s infinite alternate; letter-spacing: -5px; }
        @keyframes letterSuperPulse { 0% { transform: scale(1); } 100% { transform: scale(1.03); } }

        .tap-value { 
            color: rgba(170, 204, 255, 0.5); 
            font-size: 0.75rem; 
            text-align: center; 
            margin: 0 auto 2.5rem auto; 
            font-weight: 400;
            position: relative;
            z-index: 10; 
            background: rgba(10, 20, 35, 0.15); 
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            border: 1px solid rgba(59, 130, 246, 0.05);
            backdrop-filter: blur(2px);
            width: max-content;
            letter-spacing: 0.5px;
        }

        .floating-value { 
            position: fixed; 
            font-weight: 600; 
            font-size: 1rem; 
            color: #aaccff; 
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.25);
            border-radius: 1.5rem;
            padding: 0.2rem 0.7rem;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.1), inset 0 0 8px rgba(59, 130, 246, 0.2);
            backdrop-filter: blur(2px);
            pointer-events: none; 
            animation: floatUpAnim 0.8s ease-out forwards; 
            z-index: 9999; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .floating-value::after { content: ' $'; font-size: 0.8rem; color: #aaccff; margin-left: 2px; }
        @keyframes floatUpAnim { 
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.8); } 
            50% { opacity: 0.9; transform: translate(-50%, calc(-50% - 40px)) scale(1.05); } 
            100% { opacity: 0; transform: translate(-50%, calc(-50% - 80px)) scale(1.1); } 
        }

        .top-ref-bar { border-radius: 1.12rem; padding: 0.7rem 0.8rem; margin: 1rem 0; box-shadow: 0 3px 0 rgba(10, 26, 47, 0.6); display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .top-ref-bar:active { transform: translateY(2px); box-shadow: 0 1px 0 rgba(10, 26, 47, 0.6); }
        .top-ref-left { display: flex; align-items: center; gap: 0.6rem; }
        .top-ref-left span { font-size: 0.95rem; color: #ffffff; font-weight: 500; }
        
        .top-ref-right { 
            display: flex;
            align-items: center;
            gap: 8px; 
            background: rgba(59, 130, 246, 0.05); 
            color: #aaccff; 
            font-weight: 600; 
            font-size: 1rem; 
            padding: 0.6rem 1.1rem; 
            border-radius: 2rem; 
            border: 1px solid rgba(59, 130, 246, 0.25); 
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.1), inset 0 0 8px rgba(59, 130, 246, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(2px);
        }
        .top-ref-right svg { width: 16px; height: 16px; } 

        .feature-grid { display: flex; gap: 0.6rem; margin: 0.8rem 0 1.2rem; justify-content: center; }
        .feature-card { border-radius: 1.12rem; padding: 0.7rem 0.8rem; flex: 1; display: flex; align-items: center; justify-content: space-between; gap: 8px; box-shadow: 0 3px 0 rgba(10, 26, 47, 0.6); }
        .feature-card:active { transform: translateY(2px); box-shadow: 0 1px 0 rgba(10, 26, 47, 0.6); }
        .card-left { display: flex; align-items: center; gap: 0.6rem; min-width: 0; }
        .card-label { font-size: 0.85rem; color: #ffffff; font-weight: 500; } 
        .card-value { font-weight: 600; font-size: 0.85rem; color: #ffffff; flex-shrink: 0; }

        .tasks-section, .upgrade-section { border-radius: 1.12rem; padding: 1rem 0.4rem; margin: 1rem 0; box-shadow: 0 3px 0 rgba(10, 26, 47, 0.6); }
        .section-header { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 1rem; padding-left: 0.4rem; }
        .section-title { font-size: 1rem; font-weight: 700; color: #ffffff; text-shadow: 0 0 10px #3b82f6; }

        .upgrade-item, .task-item { background: rgba(10, 20, 35, 0.55); border-radius: 0.9rem; padding: 0.6rem 0.4rem; margin-bottom: 0.6rem; display: flex; align-items: center; justify-content: space-between; gap: 0.4rem; border: 1px solid rgba(59, 130, 246, 0.2); box-shadow: 0 2px 0 rgba(10, 26, 47, 0.5); cursor: pointer; }
        .upgrade-item:active, .task-item:active { transform: translateY(2px); box-shadow: 0 1px 0 rgba(10, 26, 47, 0.5); }

        .card-icon, .item-icon, .section-icon { width: 24px; height: 24px; min-width: 24px; min-height: 24px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .card-icon svg, .item-icon svg, .section-icon svg { width: 100%; height: 100%; display: block; filter: brightness(0) invert(1); }

        .item-left { display: flex; align-items: center; gap: 0.6rem; flex: 1; min-width: 0; }
        .item-info { display: flex; flex-direction: column; min-width: 0; width: 100%; }
        .item-name { font-weight: 600; font-size: 0.8rem; color: #ffffff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .item-level { font-size: 0.65rem; color: #aaccff; margin-top: 0.1rem; }
        
        .item-right { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
        
        .item-value { font-weight: 500; font-size: 0.75rem; color: rgba(170, 204, 255, 0.7); white-space: nowrap; }
        .task-reward { font-size: 0.7rem; font-weight: 500; color: rgba(170, 204, 255, 0.7); white-space: nowrap; }

        .item-button { 
            background: rgba(59, 130, 246, 0.05);
            color: #aaccff;
            font-weight: 500;
            font-size: 0.7rem; 
            padding: 0.35rem 0.7rem; 
            border-radius: 1.5rem; 
            border: 1px solid rgba(59, 130, 246, 0.25);
            box-shadow: 
                0 0 5px rgba(59, 130, 246, 0.1),
                inset 0 0 8px rgba(59, 130, 246, 0.3),
                inset 0 1px 2px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(2px); 
            cursor: pointer; 
            text-transform: uppercase; 
            white-space: nowrap; 
            flex-shrink: 0; 
            transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        .item-button:active { 
            transform: scale(0.92);
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 
                0 0 8px rgba(59, 130, 246, 0.2),
                inset 0 0 12px rgba(59, 130, 246, 0.4),
                inset 0 1px 2px rgba(255, 255, 255, 0.15);
            color: #ffffff;
        }

        .task-special { background: linear-gradient(145deg, #2a4a8a, #1a3a6a); border: 1px solid #3b82f6; }
        .notice { text-align: center; font-size: 0.65rem; color: #aaccff; margin-top: 1rem; border-top: 1px dashed rgba(59, 130, 246, 0.3); padding-top: 0.8rem; }

        .game-container, .top-bar, .feature-card, .upgrade-item, .task-item { transform: translateZ(0); backface-visibility: hidden; }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="handwritten-bg" id="handwrittenBg"></div>

        <div class="top-bar">
            <div class="balance-box">
                <img src="стоковая иконка юсдт.png" class="usdt-icon" alt="USDT">
                <span class="usdt-text">USDT</span>
                <span class="balance-amount" id="balanceDisplay">10.500000</span>
            </div>
        </div>

        <div class="energy-panel">
            <div class="energy-left">
                <span class="bolt">⚡</span>
                <span class="energy-count" id="energyDisplay">1000</span>
            </div>
            <div class="energy-bar-bg">
                <div class="energy-bar-fill" id="energyBarFill" style="width: 100%;"></div>
            </div>
            <span class="regen-tip" id="regenTip">+1/сек</span>
        </div>

        <div class="tap-zone" id="tapButton">
            <div class="big-coin">
                <div class="trust-logo">
                    <span class="letter-t">T</span>
                </div>
            </div>
        </div>

        <div class="tap-value" id="tapValueDisplay">0.000200 USDT за тап</div>

        <div class="top-ref-bar" id="topRefBar">
            <div class="top-ref-left">
                <span>Пригласить друга</span>
            </div>
            <div class="top-ref-right">
                <span>+500 ⚡</span>
            </div>
        </div>

        <div class="feature-grid">
            <div class="feature-card" id="rankCard">
                <span class="card-label">Ранг</span>
                <span class="card-value">Бронза</span>
            </div>
            <div class="feature-card" id="referralsCard">
                <span class="card-label">Рефералы</span>
                <span class="card-value" id="refCount">0</span>
            </div>
        </div>

        <div class="upgrade-section">
            <div class="section-header">
                <span class="section-title">Улучшения</span>
            </div>
            
            <div class="upgrade-item" id="upgradeDamage">
                <div class="item-left">
                    <div class="item-info">
                        <span class="item-name">Урон за клик</span>
                        <span class="item-level" id="damageLevel">ур. 1</span>
                    </div>
                </div>
                <div class="item-right">
                    <span class="item-value" id="damageValue">1.0x</span>
                    <button class="item-button upgrade-btn" data-type="damage">Улучшить</button>
                </div>
            </div>
            
            <div class="upgrade-item" id="upgradeCapacity">
                <div class="item-left">
                    <div class="item-info">
                        <span class="item-name">Ёмкость энергии</span>
                        <span class="item-level" id="capacityLevel">ур. 1</span>
                    </div>
                </div>
                <div class="item-right">
                    <span class="item-value" id="capacityValue">1000</span>
                    <button class="item-button upgrade-btn" data-type="capacity">Улучшить</button>
                </div>
            </div>
            
            <div class="upgrade-item" id="upgradeRecovery">
                <div class="item-left">
                    <div class="item-info">
                        <span class="item-name">Восстановление</span>
                        <span class="item-level" id="recoveryLevel">ур. 1</span>
                    </div>
                </div>
                <div class="item-right">
                    <span class="item-value" id="recoveryValue">1/сек</span>
                    <button class="item-button upgrade-btn" data-type="recovery">Улучшить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (async function() {
            // --- ТЕЛЕГРАМ ТА БАЗА ---
            let tg = window.Telegram?.WebApp || null;
            if (tg) {
                tg.ready();
                tg.expand();
                tg.disableVerticalSwipes();
            }

            const API_URL = 'https://click-9pdn.onrender.com/api'; 
            const tgUser = tg?.initDataUnsafe?.user || { id: 'test_user_1', username: 'Tester' };
            const refParam = tg?.initDataUnsafe?.start_param || null;

            const ECONOMY = {
                usdt: { decimals: 6, baseTapValue: 0.0002 },
                energy: { baseCapacity: 1000, baseRecovery: 1, tapCost: 1 },
                upgrades: {
                    damage: [1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 6.0],
                    capacity: [1.0, 1.3, 1.6, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0],
                    recovery: [1.0, 1.3, 1.6, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0]
                },
                upgradePrices: {
                    damage: [2.5, 5.0, 10.0, 20.0, 40.0, 80.0, 160.0, 320.0, 640.0, 1280.0],
                    capacity: [3.0, 6.0, 12.0, 24.0, 48.0, 96.0, 192.0, 384.0, 768.0, 1536.0],
                    recovery: [1.5, 3.0, 6.0, 12.0, 24.0, 48.0, 96.0, 192.0, 384.0, 768.0]
                }
            };

            let player = { balance: 0, damageLevel: 1, capacityLevel: 1, recoveryLevel: 1, energy: 1000, referrals: 0 };

            // --- ОБРОБКА ТАПІВ ТА UI ---
            function vibrate() {
                try {
                    if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
                    else if (navigator.vibrate) navigator.vibrate(10);
                } catch(e) {}
            }

            function updateUI() {
                document.getElementById('balanceDisplay').textContent = player.balance.toFixed(6);
                const maxEnergy = Math.floor(ECONOMY.energy.baseCapacity * ECONOMY.upgrades.capacity[player.capacityLevel - 1]);
                document.getElementById('energyDisplay').textContent = Math.floor(player.energy);
                document.getElementById('energyBarFill').style.width = `${(player.energy / maxEnergy) * 100}%`;
                document.getElementById('regenTip').textContent = `+${(ECONOMY.energy.baseRecovery * ECONOMY.upgrades.recovery[player.recoveryLevel-1]).toFixed(1)}/сек`;
                document.getElementById('tapValueDisplay').textContent = `${(ECONOMY.usdt.baseTapValue * ECONOMY.upgrades.damage[player.damageLevel - 1]).toFixed(6)} USDT за тап`;
                document.getElementById('refCount').textContent = player.referrals;
                document.getElementById('damageValue').textContent = `${ECONOMY.upgrades.damage[player.damageLevel-1].toFixed(1)}x`;
                document.getElementById('damageLevel').textContent = `ур. ${player.damageLevel}`;
                document.getElementById('capacityValue').textContent = maxEnergy;
                document.getElementById('capacityLevel').textContent = `ур. ${player.capacityLevel}`;
                document.getElementById('recoveryValue').textContent = `${(ECONOMY.energy.baseRecovery * ECONOMY.upgrades.recovery[player.recoveryLevel-1]).toFixed(1)}/сек`;
                document.getElementById('recoveryLevel').textContent = `ур. ${player.recoveryLevel}`;
            }

            function showFloating(text, x, y) {
                const div = document.createElement('div');
                div.className = 'floating-value';
                div.textContent = text;
                div.style.left = `${x}px`; div.style.top = `${y}px`;
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 800);
            }

            function processTap(x, y) {
                if (player.energy < 1) return;
                const tapValue = ECONOMY.usdt.baseTapValue * ECONOMY.upgrades.damage[player.damageLevel - 1];
                player.energy -= 1;
                player.balance += tapValue;
                vibrate();
                showFloating(`+${tapValue.toFixed(4)}`, x, y);
                updateUI();
            }

            // --- ВКЛЮЧАЄМО КНОПКИ ВІДРАЗУ ---
            const tapZone = document.getElementById('tapButton');
            const bigCoin = document.querySelector('.big-coin');

            tapZone.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                bigCoin.classList.add('pressed'); 
                for (let i = 0; i < e.changedTouches.length; i++) {
                    processTap(e.changedTouches[i].clientX, e.changedTouches[i].clientY);
                }
            }, { passive: false });

            tapZone.addEventListener('touchend', (e) => {
                if (e.touches.length === 0) bigCoin.classList.remove('pressed');
            });

            document.querySelectorAll('.upgrade-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.target.dataset.type;
                    const price = ECONOMY.upgradePrices[type][player[type + 'Level'] - 1];
                    if (player.balance >= price) {
                        vibrate();
                        player.balance -= price;
                        player[type + 'Level']++;
                        if (type === 'capacity') player.energy = Math.floor(ECONOMY.energy.baseCapacity * ECONOMY.upgrades.capacity[player.capacityLevel - 1]);
                        updateUI(); 
                        syncData(); // Зберігаємо в базу
                    } else {
                        alert(`❌ Недостатньо USDT! Потрібно: ${price}`);
                    }
                });
            });

            document.getElementById('topRefBar').addEventListener('click', () => {
                vibrate();
                const botUsername = 'teosoaodosabot'; // ВПИШИ СВОГО БОТА ТУТ
                const refLink = `https://t.me/${botUsername}?start=${tgUser.id}`;
                if (tg && tg.openTelegramLink) tg.openTelegramLink(`https://t.me/share/url?url=${refLink}`);
                else alert(`Код: ${refLink}`);
            });

            // --- ПІДКЛЮЧЕННЯ БАЗИ (ПРАЦЮЄ ФОНОМ) ---
            async function loadData() {
                try {
                    const res = await fetch(`${API_URL}/init`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ telegramId: tgUser.id.toString(), username: tgUser.username, refId: refParam })
                    });
                    const data = await res.json();
                    player.balance = data.balance; player.energy = data.energy;
                    player.damageLevel = data.damageLevel; player.capacityLevel = data.capacityLevel;
                    player.recoveryLevel = data.recoveryLevel; player.referrals = data.referrals;
                    updateUI();
                } catch (e) { console.log('База завантажується...'); }
            }

            async function syncData() {
                try {
                    await fetch(`${API_URL}/sync`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            telegramId: tgUser.id.toString(),
                            balance: player.balance, energy: player.energy,
                            levels: { damage: player.damageLevel, capacity: player.capacityLevel, recovery: player.recoveryLevel }
                        })
                    });
                } catch (e) {}
            }

            // РЕГЕНЕРАЦІЯ
            setInterval(() => {
                const max = Math.floor(ECONOMY.energy.baseCapacity * ECONOMY.upgrades.capacity[player.capacityLevel - 1]);
                const regen = ECONOMY.energy.baseRecovery * ECONOMY.upgrades.recovery[player.recoveryLevel - 1];
                if (player.energy < max) { player.energy = Math.min(max, player.energy + regen); updateUI(); }
            }, 1000);

            // АВТОЗБЕРЕЖЕННЯ
            setInterval(syncData, 10000);

            // ФОН "T"
            const bg = document.getElementById('handwrittenBg');
            for (let i = 0; i < 30; i++) {
                const s = document.createElement('span'); s.textContent = 'T';
                s.style.left = Math.random() * 100 + '%'; s.style.top = Math.random() * 100 + '%';
                s.style.setProperty('--r', (Math.random() * 60) - 30); s.style.setProperty('--d', Math.random() * 8);
                bg.appendChild(s);
            }

            loadData(); // Запускаємо завантаження
            updateUI();
        })();
    </script>
</body>
</html>