<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TRUST TAP ‚Ä¢ CRYPTO WALLET GAME</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
        body { background: #030712; display: flex; justify-content: center; align-items: flex-start; min-height: 100dvh; overflow-x: hidden; padding: 0; }
        .game-container { max-width: 480px; width: 100%; background: linear-gradient(145deg, #0f1a2f, #030a18); border-radius: 0; padding: calc(1.5rem + env(safe-area-inset-top, 20px)) 1rem 3rem 1rem; min-height: 100dvh; box-shadow: 0 30px 60px rgba(0, 0, 0, 0.9), 0 0 0 1px #1e3a5f inset; color: #ffffff; position: relative; overflow: hidden; }
        @media (min-width: 480px) { body { padding: 1rem; align-items: center; } .game-container { border-radius: 3rem 3rem 2rem 2rem; min-height: 90vh; padding: 2rem 1.5rem 2rem 1.5rem; } }
        
        .handwritten-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .handwritten-bg span { position: absolute; font-family: 'Caveat', cursive; transform: rotate(calc(var(--r) * 1deg)); animation: floatT 8s infinite alternate; animation-delay: calc(var(--d) * -1s); will-change: transform, opacity; }
        @keyframes floatT { 0% { transform: translateY(0) rotate(calc(var(--r) * 1deg)) scale(1); } 50% { transform: translateY(-15px) rotate(calc(var(--r) * 1deg)) scale(1.1); } 100% { transform: translateY(15px) rotate(calc(var(--r) * 1deg)) scale(0.9); } }
        
        .game-container::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, transparent 30%, rgba(3, 7, 18, 0.7) 90%); pointer-events: none; z-index: 0; }

        /* –ö–ù–û–ü–ö–ê –ò–ù–°–¢–†–£–ö–¶–ò–ò (–ö–Ω–∏–∂–µ—á–∫–∞) */
        .info-btn { position: absolute; top: calc(1rem + env(safe-area-inset-top, 20px)); right: 1.5rem; background: rgba(20, 40, 70, 0.55); border: 1px solid rgba(59, 130, 246, 0.3); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #aaccff; cursor: pointer; z-index: 50; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.1s ease; }
        .info-btn:active { transform: scale(0.9); }

        .top-bar, .top-ref-bar, .feature-card, .tasks-section, .upgrade-section { background: rgba(20, 40, 70, 0.55); border: 1px solid rgba(59, 130, 246, 0.2); position: relative; z-index: 2; }
        .top-bar { display: flex; justify-content: center; align-items: center; padding: 0.8rem 1.2rem; border-radius: 2.5rem; margin-bottom: 2rem; margin-top: 1rem; box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3); width: max-content; min-width: 60%; margin-left: auto; margin-right: auto; }
        .balance-box { display: flex; align-items: center; gap: 2px; }
        .usdt-icon { width: 26px; height: 26px; object-fit: contain; display: block; }
        .usdt-text { font-size: 1rem; font-weight: 600; color: #ffffff; text-shadow: 0 0 8px #3b82f6; margin-right: 6px; }
        .balance-amount { font-size: 0.9rem; font-weight: 600; color: #ffffff; text-shadow: 0 0 8px #3b82f6; white-space: nowrap; }
        .balance-amount::after { content: '$'; color: #ffffff; font-size: 0.9rem; font-weight: 600; margin-left: 2px; }

        .energy-panel { background: rgba(10, 20, 35, 0.6); border-radius: 2rem; padding: 0.4rem 0.8rem; margin: 0 auto 3rem auto; display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(59, 130, 246, 0.3); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.05); backdrop-filter: blur(5px); width: 250px; position: relative; z-index: 2; }
        .energy-left { display: flex; align-items: center; gap: 0.3rem; }
        .bolt { font-size: 0.8rem; color: #f5c45e; filter: drop-shadow(0 0 3px rgba(245, 196, 94, 0.5)); } 
        .energy-count { font-weight: 700; font-size: 0.8rem; color: #ffffff; text-shadow: 0 0 5px rgba(255,255,255,0.3); min-width: 35px; }
        .energy-bar-bg { flex-grow: 1; height: 6px; background: rgba(0, 0, 0, 0.6); border-radius: 10px; overflow: hidden; margin: 0 8px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.8); }
        .energy-bar-fill { height: 100%; width: 80%; background: linear-gradient(90deg, #3b82f6, #aaccff, #ffffff); border-radius: 10px; box-shadow: 0 0 8px #aaccff; transition: width 0.1s cubic-bezier(0.4, 0, 0.2, 1); }
        .regen-tip { color: rgba(170, 204, 255, 0.8); font-size: 0.65rem; white-space: nowrap; font-weight: 500; }

        .tap-zone { display: flex; justify-content: center; margin: 0 0 1.5rem 0; cursor: pointer; position: relative; z-index: 5; touch-action: none; }
        .big-coin { width: 250px; height: 250px; background: radial-gradient(circle at 30% 30%, #2b6ed7, #0a2a6a, #031030); border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; transition: transform 0.05s ease-out; border: 2px solid rgba(255, 255, 255, 0.4); box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.8), 0 0 0 2px rgba(59, 130, 246, 0.3) inset, 0 0 40px rgba(59, 130, 246, 0.5); animation: modernFloat 5s infinite ease-in-out; }
        .big-coin::after { content: ''; position: absolute; inset: -15px; border-radius: 50%; background: radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.6), transparent 70%); z-index: -1; animation: pulseGlow 2.5s infinite alternate; pointer-events: none; }
        @keyframes pulseGlow { 0% { opacity: 0.5; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1.05); } }
        .big-coin::before { content: ''; position: absolute; inset: 10px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.1) 60%, transparent 80%); border: 1px solid rgba(255, 255, 255, 0.4); z-index: 1; pointer-events: none; }
        @keyframes modernFloat { 0% { transform: translateY(0px); } 50% { transform: translateY(-8px); } 100% { transform: translateY(0px); } }
        .big-coin.pressed { transform: scale(0.92) !important; box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.9), 0 0 0 3px rgba(59, 130, 246, 0.8) inset, 0 0 70px #3b82f6, 0 0 120px rgba(59, 130, 246, 0.9) !important; }
        .trust-logo { position: relative; z-index: 10; width: 140px; height: 140px; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .letter-t { font-size: 8.5rem; font-weight: 900; color: #ffffff; text-shadow: 0 0 30px rgba(255, 255, 255, 0.9), 0 0 60px #3b82f6; line-height: 1; animation: letterSuperPulse 2.5s infinite alternate; letter-spacing: -5px; }
        @keyframes letterSuperPulse { 0% { transform: scale(1); } 100% { transform: scale(1.03); } }

        .tap-value { color: rgba(170, 204, 255, 0.5); font-size: 0.75rem; text-align: center; margin: 0 auto 2.5rem auto; font-weight: 400; position: relative; z-index: 10; background: rgba(10, 20, 35, 0.15); padding: 0.3rem 0.8rem; border-radius: 1rem; border: 1px solid rgba(59, 130, 246, 0.05); backdrop-filter: blur(2px); width: max-content; letter-spacing: 0.5px; }
        .floating-value { position: fixed; font-weight: 600; font-size: 1rem; color: #aaccff; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.25); border-radius: 1.5rem; padding: 0.2rem 0.7rem; box-shadow: 0 0 8px rgba(59, 130, 246, 0.1), inset 0 0 8px rgba(59, 130, 246, 0.2); backdrop-filter: blur(2px); pointer-events: none; animation: floatUpAnim 0.8s ease-out forwards; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .floating-value::after { content: ' $'; font-size: 0.8rem; color: #aaccff; margin-left: 2px; }
        @keyframes floatUpAnim { 0% { opacity: 1; transform: translate(-50%, -50%) scale(0.8); } 50% { opacity: 0.9; transform: translate(-50%, calc(-50% - 40px)) scale(1.05); } 100% { opacity: 0; transform: translate(-50%, calc(-50% - 80px)) scale(1.1); } }

        .top-ref-bar { border-radius: 1.12rem; padding: 0.7rem 0.8rem; margin: 1rem 0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: transform 0.1s ease, box-shadow 0.1s ease; }
        .top-ref-bar:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        .top-ref-left { display: flex; align-items: center; gap: 0.6rem; }
        .top-ref-left span { font-size: 0.95rem; color: #ffffff; font-weight: 500; }
        
        /* –ù–û–í–´–ô –î–ò–ó–ê–ô–ù –ö–ù–û–ü–û–ö –ü–†–ò–ì–õ–ê–°–ò–¢–¨ –î–†–£–ì–ê */
        .top-ref-right { display: flex; align-items: center; gap: 6px; }
        .ref-bonus-badge { 
            display: flex; align-items: center; gap: 4px; 
            padding: 0.4rem 0.6rem; border-radius: 1.5rem; 
            font-size: 0.8rem; font-weight: 600; 
            backdrop-filter: blur(2px); 
            background: rgba(59, 130, 246, 0.05); 
            border: 1px solid rgba(59, 130, 246, 0.25); 
            color: #aaccff; 
        }
        .badge-energy { box-shadow: 0 0 6px rgba(249, 115, 22, 0.25), inset 0 0 5px rgba(59, 130, 246, 0.1); }
        .badge-money { box-shadow: 0 0 6px rgba(74, 222, 128, 0.35), inset 0 0 5px rgba(59, 130, 246, 0.1); }

        .feature-grid { display: flex; gap: 0.6rem; margin: 0.8rem 0 1.2rem; justify-content: center; }
        .feature-card { border-radius: 1.12rem; padding: 0.7rem 0.8rem; flex: 1; display: flex; align-items: center; justify-content: space-between; gap: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); transition: transform 0.1s ease, box-shadow 0.1s ease; cursor: pointer; }
        .feature-card:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        .card-left { display: flex; align-items: center; gap: 0.6rem; min-width: 0; }
        .card-label { font-size: 0.85rem; color: #ffffff; font-weight: 500; } 
        .card-value { font-weight: 600; font-size: 0.85rem; color: #ffffff; flex-shrink: 0; display: flex; align-items: center; gap: 4px; }

        .tasks-section, .upgrade-section { border-radius: 1.12rem; padding: 1rem 0.4rem; margin: 1rem 0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .section-header { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 1rem; padding-left: 0.4rem; }
        .section-title { font-size: 1rem; font-weight: 700; color: #ffffff; text-shadow: 0 0 10px #3b82f6; }

        .upgrade-item, .task-item { background: rgba(10, 20, 35, 0.55); border-radius: 0.9rem; padding: 0.6rem 0.4rem; margin-bottom: 0.6rem; display: flex; align-items: center; justify-content: space-between; gap: 0.4rem; border: 1px solid rgba(59, 130, 246, 0.2); box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15); cursor: pointer; transition: transform 0.1s ease, box-shadow 0.1s ease; }
        .upgrade-item:active, .task-item:active { transform: scale(0.98); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); }
        .card-icon, .item-icon, .section-icon { width: 24px; height: 24px; min-width: 24px; min-height: 24px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .card-icon svg, .item-icon svg, .section-icon svg { width: 100%; height: 100%; display: block; filter: brightness(0) invert(1); }

        .item-left { display: flex; align-items: center; gap: 0.6rem; flex: 1; min-width: 0; }
        .item-info { display: flex; flex-direction: column; min-width: 0; width: 100%; }
        .item-name { font-weight: 600; font-size: 0.8rem; color: #ffffff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .item-level { font-size: 0.65rem; color: #aaccff; margin-top: 0.1rem; }
        .item-right { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
        .item-value { font-weight: 500; font-size: 0.75rem; color: rgba(170, 204, 255, 0.7); white-space: nowrap; }
        .task-reward { font-size: 0.7rem; font-weight: 500; color: rgba(170, 204, 255, 0.7); white-space: nowrap; }

        .item-button { background: rgba(59, 130, 246, 0.05); color: #aaccff; font-weight: 500; font-size: 0.7rem; padding: 0.35rem 0.7rem; border-radius: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.25); box-shadow: 0 0 5px rgba(59, 130, 246, 0.1), inset 0 0 8px rgba(59, 130, 246, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.1); backdrop-filter: blur(2px); cursor: pointer; text-transform: uppercase; white-space: nowrap; flex-shrink: 0; transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .item-button:active { transform: scale(0.92); background: rgba(59, 130, 246, 0.15); border-color: rgba(59, 130, 246, 0.4); box-shadow: 0 0 8px rgba(59, 130, 246, 0.2), inset 0 0 12px rgba(59, 130, 246, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.15); color: #ffffff; }

        .task-special { background: linear-gradient(145deg, #2a4a8a, #1a3a6a); border: 1px solid #3b82f6; }
        .notice { text-align: center; font-size: 0.65rem; color: #aaccff; margin-top: 1rem; border-top: 1px dashed rgba(59, 130, 246, 0.3); padding-top: 0.8rem; }

        /* --- –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò --- */
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #030712; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
        .loading-logo { width: 90px; height: 90px; margin-bottom: 25px; background: linear-gradient(145deg, #1e3a5f, #0f1a2f); border: 2px solid rgba(59,130,246,0.5); border-radius: 25px; display: flex; align-items: center; justify-content: center; animation: pulseGlowLoad 1.5s infinite alternate; box-shadow: 0 0 30px rgba(59,130,246,0.3); }
        .loading-logo svg { width: 45px; height: 45px; }
        @keyframes pulseGlowLoad { 0% { transform: scale(0.95); box-shadow: 0 0 20px rgba(59,130,246,0.2); } 100% { transform: scale(1.05); box-shadow: 0 0 40px rgba(59,130,246,0.6); } }
        .loading-text { color: #fff; font-size: 1.6rem; font-weight: 800; letter-spacing: 3px; text-shadow: 0 0 15px #3b82f6; }
        .loading-bar { width: 180px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 25px; overflow: hidden; position: relative; }
        .loading-progress { width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); border-radius: 10px; animation: loadAnim 2.5s ease-out forwards; box-shadow: 0 0 10px #3b82f6; }
        @keyframes loadAnim { 0% { width: 0%; } 100% { width: 100%; } }

        /* --- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 10000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: linear-gradient(145deg, #0f1a2f, #030a18); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 1.5rem; width: 90%; max-width: 400px; padding: 1.5rem; box-shadow: 0 15px 30px rgba(0,0,0,0.5); transform: scale(0.9); transition: 0.3s; max-height: 85vh; display: flex; flex-direction: column; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-header h3 { font-size: 1.2rem; color: #fff; }
        .close-btn { background: none; border: none; color: #aaccff; font-size: 2rem; line-height: 1; cursor: pointer; padding: 0 5px; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 5px; }
        .modal-body::-webkit-scrollbar { width: 4px; }
        .modal-body::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.5); border-radius: 4px; }
        
        .ref-user-item { background: rgba(10, 20, 35, 0.55); border-radius: 0.8rem; padding: 0.8rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(59, 130, 246, 0.1); }
        .ref-user-name { color: #fff; font-weight: 500; font-size: 0.9rem; }
        .ref-user-profit { color: #4ade80; font-size: 0.85rem; font-weight: 600; }
        .loading-text, .no-refs { text-align: center; color: #aaccff; font-size: 0.9rem; padding: 1rem; }

        .rank-info-item { background: rgba(10, 20, 35, 0.55); border-radius: 0.8rem; padding: 0.8rem; margin-bottom: 0.6rem; border: 1px solid rgba(59, 130, 246, 0.1); display: flex; align-items: center; justify-content: space-between; }
        .rank-info-item.active-rank { border-color: rgba(59, 130, 246, 0.6); box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); background: rgba(59, 130, 246, 0.1); }
        .rank-info-left { display: flex; align-items: center; gap: 0.6rem; }
        .rank-info-details { display: flex; flex-direction: column; }
        .rank-info-name { font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; }
        .rank-info-req { font-size: 0.7rem; color: rgba(170, 204, 255, 0.7); margin-top: 2px; }
        .rank-info-bonus { font-size: 0.75rem; font-weight: 600; color: #4ade80; background: rgba(74, 222, 128, 0.1); padding: 4px 8px; border-radius: 8px; border: 1px solid rgba(74, 222, 128, 0.2); }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" fill="rgba(59,130,246,0.2)"></path>
                <path d="M8 9h8m-4 0v8" stroke="white" stroke-width="2" stroke-linecap="round"></path>
            </svg>
        </div>
        <div class="loading-text">TRUST TAP</div>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
    </div>

    <div class="game-container">
        <button id="openGuideBtn" class="info-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px; height:20px;">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
            </svg>
        </button>

        <div class="handwritten-bg" id="handwrittenBg"></div>

        <div class="top-bar">
            <div class="balance-box">
                <img src="—Å—Ç–æ–∫–æ–≤–∞—è –∏–∫–æ–Ω–∫–∞ —é—Å–¥—Ç.png" class="usdt-icon" alt="USDT">
                <span class="usdt-text">USDT</span>
                <span class="balance-amount" id="balanceDisplay">0.000000</span>
            </div>
        </div>

        <div class="energy-panel">
            <div class="energy-left">
                <span class="bolt">‚ö°</span>
                <span class="energy-count" id="energyDisplay">1000</span>
            </div>
            <div class="energy-bar-bg">
                <div class="energy-bar-fill" id="energyBarFill" style="width: 100%;"></div>
            </div>
            <span class="regen-tip" id="regenTip">+1/—Å–µ–∫</span>
        </div>

        <div class="tap-zone" id="tapButton">
            <div class="big-coin">
                <div class="trust-logo">
                    <span class="letter-t">T</span>
                </div>
            </div>
        </div>

        <div class="tap-value" id="tapValueDisplay">0.000200 USDT –∑–∞ —Ç–∞–ø</div>

        <div class="top-ref-bar" id="topRefBar">
            <div class="top-ref-left">
                <span class="item-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 5H18L21 9L12 20L3 9L6 5Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3 9H21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 20L8 9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 20L16 9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </span>
                <span>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</span>
            </div>
            <div class="top-ref-right">
                <div class="ref-bonus-badge badge-energy">
                    <span>‚ö°</span> <span>+500</span>
                </div>
                <div class="ref-bonus-badge badge-money">
                    <span>+10%</span>
                </div>
            </div>
        </div>

        <div class="feature-grid">
            <div class="feature-card" id="rankCard">
                <div class="card-left">
                    <span class="card-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L15 8L22 9L17 14L18 21L12 17.5L6 21L7 14L2 9L9 8L12 2Z" fill="white"/>
                        </svg>
                    </span>
                    <span class="card-label">–†–∞–Ω–≥</span>
                </div>
                <span class="card-value" id="rankDisplay"></span>
            </div>
            <div class="feature-card" id="referralsCard">
                <div class="card-left">
                    <span class="card-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 11C17.66 11 19 9.66 19 8C19 6.34 17.66 5 16 5C14.34 5 13 6.34 13 8C13 9.66 14.34 11 16 11ZM8 11C9.66 11 11 9.66 11 8C11 6.34 9.66 5 8 5C6.34 5 5 6.34 5 8C5 9.66 6.34 11 8 11ZM8 13C5.79 13 2 14.79 2 17V19H22V17C22 14.79 18.21 13 16 13C14.55 13 12.81 13.55 12 14.38C11.19 13.55 9.45 13 8 13Z" fill="white"/>
                        </svg>
                    </span>
                    <span class="card-label">–†–µ—Ñ–µ—Ä–∞–ª—ã</span>
                </div>
                <span class="card-value" id="refCount">0</span>
            </div>
        </div>

        <div class="upgrade-section">
            <div class="section-header">
                <span class="section-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2"/>
                        <path d="M12 6V12L16 14" stroke="white" stroke-width="2"/>
                    </svg>
                </span>
                <span class="section-title">–£–ª—É—á—à–µ–Ω–∏—è</span>
            </div>
            
            <div class="upgrade-item" id="upgradeDamage">
                <div class="item-left">
                    <span class="item-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2"/>
                            <path d="M12 6V12L16 14" stroke="white" stroke-width="2"/>
                        </svg>
                    </span>
                    <div class="item-info">
                        <span class="item-name">–£—Ä–æ–Ω –∑–∞ –∫–ª–∏–∫</span>
                        <span class="item-level" id="damageLevel">—É—Ä. 1</span>
                    </div>
                </div>
                <div class="item-right">
                    <span class="item-value" id="damageValue">1.0x</span>
                    <button class="item-button upgrade-btn" data-type="damage">–£–ª—É—á—à–∏—Ç—å</button>
                </div>
            </div>
            
            <div class="upgrade-item" id="upgradeCapacity">
                <div class="item-left">
                    <span class="item-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="6" y="2" width="12" height="20" rx="2" stroke="white" stroke-width="2"/>
                            <rect x="10" y="6" width="4" height="4" fill="white"/>
                        </svg>
                    </span>
                    <div class="item-info">
                        <span class="item-name">–Å–º–∫–æ—Å—Ç—å —ç–Ω–µ—Ä–≥–∏–∏</span>
                        <span class="item-level" id="capacityLevel">—É—Ä. 1</span>
                    </div>
                </div>
                <div class="item-right">
                    <span class="item-value" id="capacityValue">1000</span>
                    <button class="item-button upgrade-btn" data-type="capacity">–£–ª—É—á—à–∏—Ç—å</button>
                </div>
            </div>
            
            <div class="upgrade-item" id="upgradeRecovery">
                <div class="item-left">
                    <span class="item-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" fill="white"/>
                        </svg>
                    </span>
                    <div class="item-info">
                        <span class="item-name">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</span>
                        <span class="item-level" id="recoveryLevel">—É—Ä. 1</span>
                    </div>
                </div>
                <div class="item-right">
                    <span class="item-value" id="recoveryValue">1/—Å–µ–∫</span>
                    <button class="item-button upgrade-btn" data-type="recovery">–£–ª—É—á—à–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="tasks-section">
            <div class="section-header">
                <span class="section-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="4" width="18" height="16" rx="2" stroke="white" stroke-width="2"/>
                        <path d="M8 10L11 13L16 7" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </span>
                <span class="section-title">–ó–∞–¥–∞–Ω–∏—è</span>
            </div>
            
            <div class="task-item" id="taskSubscribe">
                <div class="item-left">
                    <span class="item-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </span>
                    <span class="item-name">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª</span>
                </div>
                <div class="item-right">
                    <span class="task-reward">+0.80 USDT</span>
                    <button class="item-button task-btn" data-task="subscribe">–°—Ç–∞—Ä—Ç</button>
                </div>
            </div>
            
            <div class="task-item" id="taskAd">
                <div class="item-left">
                    <span class="item-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="2" y="6" width="20" height="12" rx="2" stroke="white" stroke-width="2"/>
                            <circle cx="17" cy="12" r="2" fill="white"/>
                        </svg>
                    </span>
                    <span class="item-name">–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–ª–∞–º—É</span>
                </div>
                <div class="item-right">
                    <span class="task-reward">+0.20 USDT</span>
                    <button class="item-button task-btn" data-task="ad">–°—Ç–∞—Ä—Ç</button>
                </div>
            </div>
            
            <div class="task-item" id="taskWallet">
                <div class="item-left">
                    <span class="item-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="6" width="18" height="12" rx="2" stroke="white" stroke-width="2"/>
                            <path d="M16 12H18" stroke="white" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="17" cy="12" r="1" fill="white"/>
                        </svg>
                    </span>
                    <span class="item-name">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–æ—à–µ–ª—ë–∫</span>
                </div>
                <div class="item-right">
                    <span class="task-reward">+22.50 USDT</span>
                    <button class="item-button task-btn" data-task="wallet">–°—Ç–∞—Ä—Ç</button>
                </div>
            </div>
            
            <div class="task-item task-special" id="taskBlum">
                <div class="item-left">
                    <span class="item-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="8" stroke="white" stroke-width="2"/>
                            <circle cx="12" cy="8" r="1" fill="white"/>
                            <circle cx="16" cy="12" r="1" fill="white"/>
                            <circle cx="8" cy="12" r="1" fill="white"/>
                            <path d="M8 16L12 18L16 16" stroke="white" stroke-width="2"/>
                        </svg>
                    </span>
                    <span class="item-name">–ö–≤–µ—Å—Ç –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</span>
                </div>
                <div class="item-right">
                    <button class="item-button task-btn" data-task="blum" disabled style="opacity: 0.5;">–°–∫–æ—Ä–æ</button>
                </div>
            </div>
        </div>

        <div class="notice">
            ‚ö° Trust Wallet ¬∑ Tap to earn
        </div>
    </div>

    <div class="modal-overlay" id="guideModal">
        <div class="modal-content" style="max-height: 85vh;">
            <div class="modal-header">
                <h3>–ö–∞–∫ –∏–≥—Ä–∞—Ç—å?</h3>
                <button class="close-btn" id="closeGuideBtn">√ó</button>
            </div>
            <div class="modal-body" style="font-size: 0.9rem; color: #cbd5e1; line-height: 1.5;">
                <p style="margin-bottom: 15px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ <b>Trust Tap</b>! –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π —Ä–µ–∞–ª—å–Ω—ã–π USDT, –ø—Ä–æ—Å—Ç–æ –∫–ª–∏–∫–∞—è –ø–æ —ç–∫—Ä–∞–Ω—É.</p>
                
                <div style="margin-bottom: 12px; background: rgba(10,20,35,0.5); padding: 10px; border-radius: 8px; border: 1px solid rgba(59,130,246,0.1);">
                    <div style="color: #fff; font-weight: 600; margin-bottom: 4px;">üëÜ –¢–∞–ø–∞–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π</div>
                    –ö–ª–∏–∫–∞–π –ø–æ –ª–æ–≥–æ—Ç–∏–ø—É –≤ —Ü–µ–Ω—Ç—Ä–µ —ç–∫—Ä–∞–Ω–∞, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å USDT. –ö–∞–∂–¥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ —Ç—Ä–∞—Ç–∏—Ç —ç–Ω–µ—Ä–≥–∏—é.
                </div>
                
                <div style="margin-bottom: 12px; background: rgba(10,20,35,0.5); padding: 10px; border-radius: 8px; border: 1px solid rgba(59,130,246,0.1);">
                    <div style="color: #fff; font-weight: 600; margin-bottom: 4px;">üöÄ –£–ª—É—á—à–µ–Ω–∏—è</div>
                    –ü—Ä–æ–∫–∞—á–∏–≤–∞–π —É—Ä–æ–Ω –∑–∞ –∫–ª–∏–∫, –µ–º–∫–æ—Å—Ç—å —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –µ—ë –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã —Ñ–∞—Ä–º–∏—Ç—å –±—ã—Å—Ç—Ä–µ–µ.
                </div>
                
                <div style="margin-bottom: 12px; background: rgba(10,20,35,0.5); padding: 10px; border-radius: 8px; border: 1px solid rgba(59,130,246,0.1);">
                    <div style="color: #fff; font-weight: 600; margin-bottom: 4px;">üèÜ –†–∞–Ω–≥–∏</div>
                    –¢–≤–æ–π —Ä–∞–Ω–≥ —Ä–∞—Å—Ç–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç <b>–æ–±—â–µ–≥–æ</b> –∑–∞—Ä–∞–±–æ—Ç–∫–∞ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è. –î–æ—Å—Ç–∏–≥–∞—è –Ω–æ–≤—ã—Ö —Ä–∞–Ω–≥–æ–≤, —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å USDT –±–æ–Ω—É—Å—ã! –ü–æ–∫—É–ø–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ –Ω–µ —Å–Ω–∏–∂–∞—é—Ç —Ç–≤–æ–π —Ä–∞–Ω–≥.
                </div>
                
                <div style="margin-bottom: 12px; background: rgba(10,20,35,0.5); padding: 10px; border-radius: 8px; border: 1px solid rgba(59,130,246,0.1);">
                    <div style="color: #fff; font-weight: 600; margin-bottom: 4px;">üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</div>
                    –ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π <b>10%</b> –æ—Ç –≤—Å–µ—Ö –∏—Ö –¥–æ—Ö–æ–¥–æ–≤ –Ω–∞–≤—Å–µ–≥–¥–∞! –ò —Å—Ä–∞–∑—É +500 —ç–Ω–µ—Ä–≥–∏–∏ –∑–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞!
                </div>

                <div style="margin-bottom: 12px; background: rgba(10,20,35,0.5); padding: 10px; border-radius: 8px; border: 1px solid rgba(59,130,246,0.1);">
                    <div style="color: #fff; font-weight: 600; margin-bottom: 4px;">üí≥ –í—ã–≤–æ–¥</div>
                    –í –±—É–¥—É—â–µ–º —Ç—ã —Å–º–æ–∂–µ—à—å –≤—ã–≤–µ—Å—Ç–∏ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ USDT –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ —Å–≤–æ–π –∫—Ä–∏–ø—Ç–æ–∫–æ—à–µ–ª–µ–∫ (Trust Wallet –∏ –¥—Ä.).
                </div>
                
                <button id="startGameBtn" class="item-button" style="width: 100%; margin-top: 10px; padding: 0.9rem; font-size: 1rem; background: rgba(59, 130, 246, 0.2); color: #fff;">–ü–æ–Ω—è—Ç–Ω–æ, –≤ –∏–≥—Ä—É!</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="referralsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ú–æ–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</h3>
                <button class="close-btn" id="closeReferralsModal">√ó</button>
            </div>
            <div class="modal-body" id="referralsList">
                <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="ranksInfoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–°–∏—Å—Ç–µ–º–∞ —Ä–∞–Ω–≥–æ–≤</h3>
                <button class="close-btn" id="closeRanksInfoModal">√ó</button>
            </div>
            <div class="modal-body" id="ranksList">
                </div>
        </div>
    </div>

    <div class="modal-overlay" id="rankModal">
        <div class="modal-content" style="text-align: center; border: 1px solid rgba(59, 130, 246, 0.4); box-shadow: 0 0 30px rgba(59, 130, 246, 0.2);">
            <div id="modalRankIcon" style="font-size: 3.5rem; margin-bottom: 5px; animation: modernFloat 3s infinite ease-in-out;">üèÜ</div>
            <h3 style="color: #ffffff; font-size: 1.3rem; margin-bottom: 5px;">–ù–æ–≤—ã–π —Ä–∞–Ω–≥!</h3>
            <p style="color: #aaccff; font-size: 0.95rem; margin-bottom: 5px;">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, –≤—ã –ø–æ–ª—É—á–∏–ª–∏ <span id="modalRankLevel">2</span> —Ä–∞–Ω–≥</p>
            <div id="modalRankName" style="font-size: 1.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin: 10px 0;">"–°–ò–õ–¨–í–ï–†"</div>
            
            <div style="background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); padding: 12px; border-radius: 12px; margin-top: 10px; display: inline-block;">
                <span style="color: #4ade80; font-weight: 600; font-size: 1.1rem;">–ë–æ–Ω—É—Å: +<span id="modalRankBonus">1</span>$ USDT</span>
            </div>
            
            <button id="closeRankModalBtn" class="item-button" style="width: 100%; margin-top: 1.5rem; padding: 0.9rem; font-size: 0.95rem; background: rgba(59, 130, 246, 0.15); color: #fff; border-color: rgba(59, 130, 246, 0.5);">–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É</button>
        </div>
    </div>

    <script>
        (function() {
            let tg = window.Telegram?.WebApp || null;
            if (tg) {
                tg.ready();
                tg.expand();
                tg.disableVerticalSwipes();
                requestAnimationFrame(() => {
                    window.scrollTo(0, 1);
                    setTimeout(() => window.scrollTo(0, 0), 50);
                });
            }

            const API_URL = 'https://click-9pdn.onrender.com/api'; 
            const tgUser = tg?.initDataUnsafe?.user || { id: 'test_user_1', username: '–ò–≥—Ä–æ–∫' };
            const refParam = tg?.initDataUnsafe?.start_param || null;
            const tgInitData = tg?.initData || ''; 
            let sessionId = null; 

            // –°–£–ü–ï–† –ö–†–ê–°–ò–í–´–ï 3D –ò–ö–û–ù–ö–ò –î–õ–Ø –†–ê–ù–ì–û–í (–ë–µ–∑ —Ü–∏—Ñ—Ä, –≤ –Ω–∞—à–µ–º –¥–∏–∑–∞–π–Ω–µ)
            const createIcon = (color) => `<svg viewBox="0 0 24 24" width="22" height="22" style="display:inline-block; margin-right: 4px; vertical-align:-5px; filter:drop-shadow(0 0 4px ${color});">
                <path d="M12 2 L2 8 L12 14 L22 8 Z" fill="#ffffff" opacity="0.9"/>
                <path d="M2 8 L2 16 L12 22 L12 14 Z" fill="${color}" opacity="0.3"/>
                <path d="M22 8 L22 16 L12 22 L12 14 Z" fill="${color}" opacity="0.7"/>
                <path d="M12 2 L2 8 L2 16 L12 22 L22 16 L22 8 Z" fill="none" stroke="${color}" stroke-width="1.5"/>
                <path d="M2 8 L12 14 L22 8 M12 14 L12 22" fill="none" stroke="${color}" stroke-width="1.5" opacity="0.7"/>
            </svg>`;

            const RANKS = [
                { id: 1, name: '–ë—Ä–æ–Ω–∑–∞', icon: createIcon('#e89543'), color: '#e89543', threshold: 0, bonus: 0 },
                { id: 2, name: '–°–∏–ª—å–≤–µ—Ä', icon: createIcon('#cbd5e1'), color: '#cbd5e1', threshold: 2.5, bonus: 1 },
                { id: 3, name: '–ó–æ–ª–æ—Ç–æ', icon: createIcon('#fbbf24'), color: '#fbbf24', threshold: 10, bonus: 3 },
                { id: 4, name: '–ü–ª–∞—Ç–∏–Ω—É–º', icon: 'üí†', color: '#e2e8f0', threshold: 50, bonus: 5 },
                { id: 5, name: '–î–∏–∞–º–∞–Ω—Ç', icon: 'üíé', color: '#22d3ee', threshold: 150, bonus: 10 }
            ];

            const ECONOMY = {
                usdt: { decimals: 6, baseTapValue: 0.0002 },
                energy: { baseCapacity: 1000, baseRecovery: 1, tapCost: 1 },
                upgrades: {
                    damage: [1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 6.0],
                    capacity: [1.0, 1.3, 1.6, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0],
                    recovery: [1.0, 1.3, 1.6, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0]
                },
                upgradePrices: {
                    damage: [2.5, 5.0, 10.0, 20.0, 40.0, 80.0, 160.0, 320.0, 640.0, 1280.0],
                    capacity: [3.0, 6.0, 12.0, 24.0, 48.0, 96.0, 192.0, 384.0, 768.0, 1536.0],
                    recovery: [1.5, 3.0, 6.0, 12.0, 24.0, 48.0, 96.0, 192.0, 384.0, 768.0]
                }
            };

            let player = {
                balance: 0, totalEarned: 0, totalSpent: 0, 
                damageLevel: 1, capacityLevel: 1, recoveryLevel: 1,
                energy: 1000, referrals: 0, rank: 1
            };

            // –õ–û–ì–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò –ò –û–ë–£–ß–ï–ù–ò–Ø
            let appLoaded = false;
            let minTimePassed = false;
            
            setTimeout(() => { 
                minTimePassed = true; 
                checkHideLoading(); 
            }, 2000); 

            function checkHideLoading() {
                if (appLoaded && minTimePassed) {
                    const loader = document.getElementById('loadingScreen');
                    loader.style.opacity = '0';
                    setTimeout(() => {
                        loader.style.display = 'none';
                        if (!localStorage.getItem('trustTapGuideShown')) {
                            document.getElementById('guideModal').classList.add('active');
                            localStorage.setItem('trustTapGuideShown', 'true');
                        }
                    }, 500);
                }
            }

            // –ö–ù–û–ü–ö–ò –ì–ê–ô–î–ê
            document.getElementById('openGuideBtn').addEventListener('click', () => {
                vibrate();
                document.getElementById('guideModal').classList.add('active');
            });
            document.getElementById('closeGuideBtn').addEventListener('click', () => {
                document.getElementById('guideModal').classList.remove('active');
            });
            document.getElementById('startGameBtn').addEventListener('click', () => {
                vibrate();
                document.getElementById('guideModal').classList.remove('active');
            });

            function formatUSDT(value) { return parseFloat(value || 0).toFixed(6); }
            function getCurrentTapValue() { return (ECONOMY.usdt.baseTapValue * ECONOMY.upgrades.damage[player.damageLevel - 1]).toFixed(6); }
            function getCurrentCapacity() { return Math.floor(ECONOMY.energy.baseCapacity * ECONOMY.upgrades.capacity[player.capacityLevel - 1]); }
            function getCurrentRecovery() { return ECONOMY.energy.baseRecovery * ECONOMY.upgrades.recovery[player.recoveryLevel - 1]; }

            function updateUI() {
                document.getElementById('balanceDisplay').textContent = formatUSDT(player.balance);
                const maxEnergy = getCurrentCapacity();
                document.getElementById('energyDisplay').textContent = Math.floor(player.energy);
                document.getElementById('energyBarFill').style.width = `${(player.energy / maxEnergy) * 100}%`;
                document.getElementById('regenTip').textContent = `+${getCurrentRecovery().toFixed(1)}/—Å–µ–∫`;
                document.getElementById('tapValueDisplay').textContent = `${getCurrentTapValue()} USDT –∑–∞ —Ç–∞–ø`;
                document.getElementById('refCount').textContent = player.referrals;
                document.getElementById('damageValue').textContent = `${ECONOMY.upgrades.damage[player.damageLevel-1].toFixed(1)}x`;
                document.getElementById('damageLevel').textContent = `—É—Ä. ${player.damageLevel}`;
                document.getElementById('capacityValue').textContent = maxEnergy;
                document.getElementById('capacityLevel').textContent = `—É—Ä. ${player.capacityLevel}`;
                document.getElementById('recoveryValue').textContent = `${getCurrentRecovery().toFixed(1)}/—Å–µ–∫`;
                document.getElementById('recoveryLevel').textContent = `—É—Ä. ${player.recoveryLevel}`;

                const currentRank = RANKS[player.rank - 1];
                const rankDisplay = document.getElementById('rankDisplay');
                rankDisplay.innerHTML = `${currentRank.icon} <span style="margin-left:2px">${currentRank.name}</span>`;
                rankDisplay.style.color = currentRank.color;
                rankDisplay.style.textShadow = `0 0 8px ${currentRank.color}60`;
            }

            function vibrate() {
                try {
                    if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
                    else if (navigator.vibrate) navigator.vibrate(10);
                } catch(e) {}
            }

            function showFloating(text, x, y) {
                const div = document.createElement('div');
                div.className = 'floating-value';
                div.textContent = text;
                div.style.left = `${x}px`; div.style.top = `${y}px`;
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 800);
            }

            function checkRankUp() {
                let rankUpgraded = false;
                let lastRankObj = null;

                while (player.rank < 5 && player.totalEarned >= RANKS[player.rank].threshold) {
                    const nextRank = RANKS[player.rank];
                    player.rank = nextRank.id;
                    player.balance = parseFloat((player.balance + nextRank.bonus).toFixed(6));
                    player.totalEarned = parseFloat((player.totalEarned + nextRank.bonus).toFixed(6));
                    lastRankObj = nextRank;
                    rankUpgraded = true;
                }

                if (rankUpgraded && lastRankObj) {
                    vibrate();
                    document.getElementById('modalRankIcon').innerHTML = lastRankObj.icon;
                    document.getElementById('modalRankLevel').textContent = lastRankObj.id;
                    
                    const rankNameEl = document.getElementById('modalRankName');
                    rankNameEl.textContent = `"${lastRankObj.name}"`;
                    rankNameEl.style.color = lastRankObj.color;
                    rankNameEl.style.textShadow = `0 0 15px ${lastRankObj.color}80`;
                    
                    document.getElementById('modalRankBonus').textContent = lastRankObj.bonus;
                    document.getElementById('rankModal').classList.add('active');
                    
                    updateUI();
                    syncData(); 
                }
            }

            document.getElementById('closeRankModalBtn').addEventListener('click', () => {
                document.getElementById('rankModal').classList.remove('active');
            });

            const tapZone = document.getElementById('tapButton');
            const bigCoin = document.querySelector('.big-coin');

            function handleTap(x, y) {
                if (player.energy >= ECONOMY.energy.tapCost) {
                    const val = parseFloat(getCurrentTapValue());
                    player.energy -= ECONOMY.energy.tapCost;
                    
                    player.balance = parseFloat((player.balance + val).toFixed(6));
                    player.totalEarned = parseFloat((player.totalEarned + val).toFixed(6)); 
                    
                    vibrate();
                    showFloating(`+${val.toFixed(4)}`, x, y);
                    updateUI();
                    checkRankUp(); 
                }
            }

            tapZone.addEventListener('touchstart', (e) => {
                e.preventDefault();
                bigCoin.classList.add('pressed');
                for (let i = 0; i < e.changedTouches.length; i++) {
                    handleTap(e.changedTouches[i].clientX, e.changedTouches[i].clientY);
                }
            }, { passive: false });

            tapZone.addEventListener('touchend', (e) => {
                if (e.touches.length === 0) bigCoin.classList.remove('pressed');
            });

            document.querySelectorAll('.upgrade-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.target.dataset.type;
                    const price = ECONOMY.upgradePrices[type][player[type + 'Level'] - 1];
                    if (player.balance >= price) {
                        vibrate();
                        player.balance = parseFloat((player.balance - price).toFixed(6));
                        player.totalSpent = parseFloat((player.totalSpent + price).toFixed(6)); 
                        player[type + 'Level']++;
                        if (type === 'capacity') player.energy = getCurrentCapacity();
                        updateUI();
                        syncData(); 
                    } else {
                        alert(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ USDT! –ù—É–∂–Ω–æ: ${price}`);
                    }
                });
            });

            document.querySelectorAll('.task-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const task = e.target.dataset.task;
                    let reward = 0;
                    if (task === 'subscribe') reward = ECONOMY.tasks.subscription;
                    else if (task === 'ad') reward = ECONOMY.tasks.adReward;
                    else if (task === 'wallet') reward = ECONOMY.tasks.walletReward;
                    
                    if (reward > 0) {
                        player.balance = parseFloat((player.balance + reward).toFixed(6));
                        player.totalEarned = parseFloat((player.totalEarned + reward).toFixed(6));
                        showFloating(`+${reward.toFixed(2)}`, window.innerWidth / 2, window.innerHeight / 2);
                        updateUI();
                        checkRankUp();
                        alert(`‚úÖ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! +${reward} USDT`);
                    }
                });
            });

            document.getElementById('topRefBar').addEventListener('click', () => {
                vibrate();
                const botUser = 'teosoaodosabot'; 
                const link = `https://t.me/${botUser}/app?startapp=${tgUser.id}`;
                if (tg && tg.openTelegramLink) tg.openTelegramLink(`https://t.me/share/url?url=${link}&text=–ó–∞–±–∏—Ä–∞–π USDT!`);
                else alert(`–°—Å—ã–ª–∫–∞: ${link}`);
            });

            // –û–ö–ù–û –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –†–ê–ù–ì–ê–• (–ü–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º)
            document.getElementById('rankCard').addEventListener('click', () => {
                vibrate();
                const modal = document.getElementById('ranksInfoModal');
                const list = document.getElementById('ranksList');
                list.innerHTML = '';
                
                RANKS.forEach(r => {
                    const isActive = player.rank === r.id;
                    const div = document.createElement('div');
                    div.className = `rank-info-item ${isActive ? 'active-rank' : ''}`;
                    
                    const reqText = r.threshold > 0 ? `–û—Ç ${r.threshold}$ –æ–±—â–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∫–∞` : `–í—ã–¥–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É`;
                    const bonusText = r.bonus > 0 ? `+${r.bonus}$ –±–æ–Ω—É—Å` : `–ù–∞—á–∞–ª—å–Ω—ã–π`;

                    div.innerHTML = `
                        <div class="rank-info-left">
                            <span class="rank-info-icon" style="display:flex; align-items:center;">${r.icon}</span>
                            <div class="rank-info-details">
                                <span class="rank-info-name" style="color: ${r.color}; text-shadow: 0 0 5px ${r.color}60;">${r.name}</span>
                                <span class="rank-info-req">${reqText}</span>
                            </div>
                        </div>
                        <div class="rank-info-bonus">
                            ${bonusText}
                        </div>
                    `;
                    list.appendChild(div);
                });
                modal.classList.add('active');
            });

            document.getElementById('closeRanksInfoModal').addEventListener('click', () => {
                document.getElementById('ranksInfoModal').classList.remove('active');
            });

            document.getElementById('referralsCard').addEventListener('click', async () => {
                vibrate();
                const modal = document.getElementById('referralsModal');
                const listContainer = document.getElementById('referralsList');
                modal.classList.add('active');
                listContainer.innerHTML = '<div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                
                try {
                    const res = await fetch(`${API_URL}/referralsList/${tgUser.id}`);
                    const refs = await res.json();
                    
                    if (refs.length === 0) {
                        listContainer.innerHTML = '<div class="no-refs">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ üòî</div>';
                        return;
                    }
                    
                    listContainer.innerHTML = '';
                    refs.forEach(r => {
                        const div = document.createElement('div');
                        div.className = 'ref-user-item';
                        div.innerHTML = `
                            <span class="ref-user-name">@${r.username || '–ò–≥—Ä–æ–∫'}</span>
                            <span class="ref-user-profit">+${r.earnedForInviter.toFixed(4)} $</span>
                        `;
                        listContainer.appendChild(div);
                    });
                } catch (e) {
                    listContainer.innerHTML = '<div class="loading-text" style="color:#ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            });

            document.getElementById('closeReferralsModal').addEventListener('click', () => {
                document.getElementById('referralsModal').classList.remove('active');
            });

            async function loadData() {
                try {
                    const res = await fetch(`${API_URL}/init`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            telegramId: tgUser.id.toString(), 
                            username: tgUser.username, 
                            refId: refParam,
                            initData: tgInitData 
                        })
                    });
                    const data = await res.json();
                    
                    if (data.error) {
                        console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", data.error);
                    } else if (data.telegramId) {
                        sessionId = data.sessionId; 
                        player = {
                            balance: data.balance,
                            totalEarned: data.totalEarned || 0,
                            totalSpent: data.totalSpent || 0,
                            energy: data.energy,
                            damageLevel: data.damageLevel,
                            capacityLevel: data.capacityLevel,
                            recoveryLevel: data.recoveryLevel,
                            referrals: data.referrals,
                            rank: data.rank || 1
                        };
                        updateUI();
                        checkRankUp(); 
                    }
                } catch (e) { 
                    console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...'); 
                } finally {
                    appLoaded = true;
                    checkHideLoading();
                }
            }

            async function syncData() {
                if (!sessionId) return; 

                const syncEarned = player.totalEarned;
                const syncSpent = player.totalSpent;

                try {
                    const res = await fetch(`${API_URL}/sync`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            telegramId: tgUser.id.toString(),
                            clientTotalEarned: syncEarned,
                            clientSpent: syncSpent,
                            clientEnergy: player.energy,
                            levels: { damage: player.damageLevel, capacity: player.capacityLevel, recovery: player.recoveryLevel },
                            rank: player.rank,
                            initData: tgInitData,
                            sessionId: sessionId 
                        })
                    });
                    const data = await res.json();
                    
                    if (data.error === "conflict") {
                        alert('‚ö†Ô∏è ' + data.message + '\n–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É!');
                        sessionId = null; 
                        return;
                    }

                    if (data.success) {
                        player.balance = data.balance + (player.totalEarned - syncEarned) - (player.totalSpent - syncSpent);
                        player.referrals = data.referrals;
                        updateUI();
                        checkRankUp(); 
                    }
                } catch (e) {}
            }

            document.addEventListener("visibilitychange", function() {
                if (document.visibilityState === 'hidden') {
                    syncData();
                }
            });

            setInterval(() => {
                const max = getCurrentCapacity();
                const regen = getCurrentRecovery();
                if (player.energy < max) {
                    player.energy = Math.min(max, player.energy + regen);
                    updateUI();
                }
            }, 1000);

            setInterval(syncData, 30000);

            const bg = document.getElementById('handwrittenBg');
            bg.innerHTML = '';
            const totalT = 80; 
            for(let i = 0; i < totalT; i++) {
                const s = document.createElement('span'); 
                s.textContent = 'T';
                s.style.left = Math.random() * 100 + '%'; 
                s.style.top = Math.random() * 100 + '%';
                s.style.setProperty('--r', Math.random() * 60 - 30); 
                s.style.setProperty('--d', Math.random() * 8);
                
                if (Math.random() < 0.20) {
                    s.style.opacity = (0.5 + Math.random() * 0.4).toFixed(2);
                    s.style.fontSize = (1.2 + Math.random() * 1.5) + 'rem';
                    s.style.color = '#aaccff'; 
                    s.style.textShadow = '0 0 10px #3b82f6, 0 0 15px #ffffff';
                    s.style.fontWeight = '600';
                    s.style.zIndex = '1';
                } else {
                    s.style.opacity = (0.15 + Math.random() * 0.25).toFixed(2);
                    s.style.fontSize = (0.8 + Math.random() * 1.2) + 'rem';
                    s.style.color = '#3b82f6';
                }
                bg.appendChild(s);
            }

            loadData();
        })();
    </script>
</body>
</html>