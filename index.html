<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TRUST TAP • CRYPTO WALLET GAME</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none; user-select: none;
        }

        body {
            background: #030712; display: flex; justify-content: center;
            align-items: flex-start; min-height: 100dvh; overflow-x: hidden;
        }

        .game-container {
            max-width: 480px; width: 100%;
            background: linear-gradient(145deg, #0f1a2f, #030a18);
            padding: calc(1.5rem + env(safe-area-inset-top, 20px)) 1rem 3rem 1rem;
            min-height: 100dvh; position: relative; overflow: hidden;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.9), 0 0 0 1px #1e3a5f inset;
            color: #ffffff;
        }

        .handwritten-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.3; }
        .handwritten-bg span { 
            position: absolute; font-family: 'Caveat', cursive; color: #3b82f6; 
            animation: floatT 8s infinite alternate; opacity: 0.6;
        }
        @keyframes floatT { 
            0% { transform: translateY(0) rotate(calc(var(--r) * 1deg)) scale(1); } 
            100% { transform: translateY(15px) rotate(calc(var(--r) * 1deg)) scale(0.9); } 
        }

        .top-bar { 
            display: flex; justify-content: center; padding: 0.8rem 1.2rem; 
            background: rgba(20, 40, 70, 0.55); border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 2.5rem; margin: 0 auto 2rem auto; width: max-content; z-index: 2; position: relative;
        }
        
        .balance-box { display: flex; align-items: center; gap: 5px; }
        .usdt-text { font-size: 1rem; font-weight: 600; text-shadow: 0 0 8px #3b82f6; }
        .balance-amount { font-size: 0.9rem; font-weight: 600; }

        .energy-panel { 
            background: rgba(10, 20, 35, 0.6); border-radius: 2rem; padding: 0.4rem 0.8rem; 
            margin: 0 auto 3rem auto; display: flex; align-items: center; width: 250px; 
            border: 1px solid rgba(59, 130, 246, 0.3); position: relative; z-index: 2;
        }
        .energy-bar-bg { flex-grow: 1; height: 6px; background: rgba(0, 0, 0, 0.6); border-radius: 10px; margin: 0 8px; overflow: hidden; }
        .energy-bar-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #ffffff); transition: width 0.2s; }

        .tap-zone { display: flex; justify-content: center; margin-bottom: 1.5rem; cursor: pointer; z-index: 5; position: relative; touch-action: none; }
        .big-coin { 
            width: 250px; height: 250px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #2b6ed7, #031030); 
            display: flex; align-items: center; justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.4); transition: transform 0.05s;
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.5);
        }
        .big-coin.pressed { transform: scale(0.92); }
        .letter-t { font-size: 8.5rem; font-weight: 900; text-shadow: 0 0 30px #3b82f6; }

        .upgrade-item, .task-item, .top-ref-bar, .feature-card {
            background: rgba(20, 40, 70, 0.55); border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 1.12rem; padding: 0.8rem; margin-bottom: 0.6rem;
            display: flex; align-items: center; justify-content: space-between; z-index: 2; position: relative;
        }

        .item-button { 
            background: rgba(59, 130, 246, 0.2); color: #aaccff; border: 1px solid #3b82f6;
            padding: 0.4rem 0.8rem; border-radius: 1rem; cursor: pointer; font-size: 0.7rem;
        }

        .floating-value { 
            position: fixed; color: #aaccff; font-weight: bold; pointer-events: none;
            animation: floatUp 0.8s ease-out forwards; z-index: 9999;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-80px); } }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="handwritten-bg" id="handwrittenBg"></div>

        <div class="top-bar">
            <div class="balance-box">
                <span class="usdt-text">USDT</span>
                <span class="balance-amount" id="balanceDisplay">0.000000</span>
            </div>
        </div>

        <div class="energy-panel">
            <span id="energyDisplay">1000</span>
            <div class="energy-bar-bg">
                <div class="energy-bar-fill" id="energyBarFill" style="width: 100%;"></div>
            </div>
            <span style="font-size: 0.6rem;" id="regenTip">+1/с</span>
        </div>

        <div class="tap-zone" id="tapButton">
            <div class="big-coin">
                <span class="letter-t">T</span>
            </div>
        </div>

        <div id="tapValueDisplay" style="text-align:center; font-size:0.7rem; color:#aaa; margin-bottom:2rem;">0.000200 USDT за тап</div>

        <div class="upgrade-section">
            <div class="upgrade-item">
                <div><span>Урон</span><br><small id="damageLevel">ур. 1</small></div>
                <button class="item-button upgrade-btn" data-type="damage">Улучшить</button>
            </div>
            <div class="upgrade-item">
                <div><span>Энергия</span><br><small id="capacityLevel">ур. 1</small></div>
                <button class="item-button upgrade-btn" data-type="capacity">Улучшить</button>
            </div>
        </div>

        <div class="tasks-section" style="margin-top: 1rem;">
            <div class="task-item">
                <span>Подписка</span>
                <button class="item-button task-btn" data-task="subscribe">+0.80</button>
            </div>
        </div>
    </div>

    <script>
        (async function() {
            // --- ТЕЛЕГРАМ ТА НАЛАШТУВАННЯ ---
            let tg = window.Telegram?.WebApp || null;
            if (tg) { tg.ready(); tg.expand(); tg.disableVerticalSwipes(); }

            const API_URL = 'https://click-9pdn.onrender.com/api'; 
            const tgUser = tg?.initDataUnsafe?.user || { id: 'test_123', username: 'Локальний_Тест' };

            // --- ЕКОНОМІКА ---
            const ECONOMY = {
                baseTap: 0.0002,
                upgradePrices: [2.5, 5, 10, 20, 40, 80, 150, 300, 600, 1200],
                multipliers: [1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 6]
            };

            let player = {
                balance: 0, energy: 1000, 
                damageLevel: 1, capacityLevel: 1, recoveryLevel: 1, referrals: 0
            };

            // --- 1. ЗАВАНТАЖЕННЯ ДАНИХ (ПРИ ВХОДІ) ---
            async function loadData() {
                try {
                    const res = await fetch(`${API_URL}/init`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ telegramId: tgUser.id.toString(), username: tgUser.username })
                    });
                    const data = await res.json();
                    player.balance = data.balance || 0;
                    player.energy = data.energy || 1000;
                    player.damageLevel = data.damageLevel || 1;
                    player.capacityLevel = data.capacityLevel || 1;
                    player.recoveryLevel = data.recoveryLevel || 1;
                    player.referrals = data.referrals || 0;
                    updateUI();
                } catch (e) { console.log("Сервер прокидається..."); }
            }

            // --- 2. АВТОЗБЕРЕЖЕННЯ (КОЖНІ 10 СЕК) ---
            async function syncData() {
                try {
                    await fetch(`${API_URL}/sync`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            telegramId: tgUser.id.toString(),
                            balance: player.balance,
                            energy: player.energy,
                            levels: { damage: player.damageLevel, capacity: player.capacityLevel, recovery: player.recoveryLevel }
                        })
                    });
                } catch (e) { console.error("Помилка збереження"); }
            }

            // --- ЛОГІКА UI ---
            function updateUI() {
                const maxEnergy = 1000 * ECONOMY.multipliers[player.capacityLevel - 1];
                document.getElementById('balanceDisplay').textContent = player.balance.toFixed(6);
                document.getElementById('energyDisplay').textContent = Math.floor(player.energy);
                document.getElementById('energyBarFill').style.width = (player.energy / maxEnergy * 100) + '%';
                document.getElementById('damageLevel').textContent = 'ур. ' + player.damageLevel;
                document.getElementById('capacityLevel').textContent = 'ур. ' + player.capacityLevel;
                document.getElementById('tapValueDisplay').textContent = (ECONOMY.baseTap * ECONOMY.multipliers[player.damageLevel-1]).toFixed(6) + ' USDT за тап';
            }

            function showFloating(x, y, val) {
                const div = document.createElement('div');
                div.className = 'floating-value';
                div.style.left = x + 'px'; div.style.top = y + 'px';
                div.textContent = '+' + val;
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 800);
            }

            // --- ТАПИ ТА ПОКРАЩЕННЯ ---
            function processTap(x, y) {
                const cost = 1;
                const val = ECONOMY.baseTap * ECONOMY.multipliers[player.damageLevel - 1];
                if (player.energy >= cost) {
                    player.energy -= cost;
                    player.balance += val;
                    showFloating(x, y, val.toFixed(4));
                    updateUI();
                    if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
                }
            }

            function buyUpgrade(type) {
                const lvl = player[type + 'Level'];
                if (lvl >= 10) return alert("Максимум!");
                const price = ECONOMY.upgradePrices[lvl - 1];
                if (player.balance >= price) {
                    player.balance -= price;
                    player[type + 'Level']++;
                    updateUI();
                    syncData();
                } else { alert("Не вистачає коштів!"); }
            }

            // --- СТАРТ ---
            document.getElementById('tapButton').addEventListener('touchstart', (e) => {
                e.preventDefault();
                document.querySelector('.big-coin').classList.add('pressed');
                processTap(e.touches[0].clientX, e.touches[0].clientY);
            });
            document.getElementById('tapButton').addEventListener('touchend', () => {
                document.querySelector('.big-coin').classList.remove('pressed');
            });

            document.querySelectorAll('.upgrade-btn').forEach(b => {
                b.addEventListener('click', () => buyUpgrade(b.dataset.type));
            });

            // Регенерація
            setInterval(() => {
                const max = 1000 * ECONOMY.multipliers[player.capacityLevel - 1];
                if (player.energy < max) { player.energy = Math.min(max, player.energy + 1); updateUI(); }
            }, 1000);

            // Фон
            const bg = document.getElementById('handwrittenBg');
            for(let i=0; i<30; i++) {
                const s = document.createElement('span'); s.textContent = 'T';
                s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%';
                s.style.setProperty('--r', Math.random()*360);
                bg.appendChild(s);
            }

            // Запуск мережевих функцій
            await loadData();
            setInterval(syncData, 10000); 

        })();
    </script>
</body>
</html>
