<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRUST TAP ‚Ä¢ CRYPTO WALLET GAME</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* –í—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            background: #030712;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 480px;
            width: 100%;
            background: linear-gradient(145deg, #0f1a2f, #030a18);
            padding: calc(1.5rem + env(safe-area-inset-top)) 1rem 3rem 1rem;
            min-height: 100dvh;
            color: #ffffff;
            position: relative;
        }

        .top-bar {
            background: rgba(20, 40, 70, 0.55);
            border: 1px solid rgba(59, 130, 246, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.8rem 1.2rem;
            border-radius: 2.5rem;
            margin-bottom: 2rem;
            width: max-content;
            margin-left: auto;
            margin-right: auto;
        }

        .balance-box {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .balance-amount {
            font-size: 0.9rem;
            font-weight: 600;
            color: #ffffff;
        }

        .energy-panel {
            background: rgba(10, 20, 35, 0.6);
            border-radius: 2rem;
            padding: 0.4rem 0.8rem;
            margin: 0 auto 3rem auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid rgba(59, 130, 246, 0.3);
            width: 250px;
        }

        .energy-left {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .bolt {
            font-size: 0.8rem;
            color: #f5c45e;
        }

        .energy-count {
            font-weight: 700;
            font-size: 0.8rem;
            min-width: 35px;
        }

        .energy-bar-bg {
            flex-grow: 1;
            height: 6px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            overflow: hidden;
            margin: 0 8px;
        }

        .energy-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #aaccff);
            border-radius: 10px;
            transition: width 0.1s;
        }

        .tap-zone {
            display: flex;
            justify-content: center;
            margin: 0 0 1.5rem 0;
            cursor: pointer;
            touch-action: none;
        }

        .big-coin {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle at 30% 30%, #2b6ed7, #0a2a6a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.05s;
            border: 2px solid rgba(255, 255, 255, 0.4);
            animation: float 5s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .big-coin.pressed {
            transform: scale(0.92) !important;
        }

        .letter-t {
            font-size: 8.5rem;
            font-weight: 900;
            color: #ffffff;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.9);
        }

        .tap-value {
            color: rgba(170, 204, 255, 0.5);
            font-size: 0.75rem;
            text-align: center;
            margin: 0 auto 2.5rem auto;
            background: rgba(10, 20, 35, 0.15);
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            width: max-content;
        }

        .top-ref-bar {
            background: rgba(20, 40, 70, 0.55);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 1.12rem;
            padding: 0.7rem 0.8rem;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .feature-grid {
            display: flex;
            gap: 0.6rem;
            margin: 0.8rem 0 1.2rem;
            justify-content: center;
        }

        .feature-card {
            background: rgba(20, 40, 70, 0.55);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 1.12rem;
            padding: 0.7rem 0.8rem;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .upgrade-section, .tasks-section {
            background: rgba(20, 40, 70, 0.55);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 1.12rem;
            padding: 1rem 0.4rem;
            margin: 1rem 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 1rem;
            padding-left: 0.4rem;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 700;
            color: #ffffff;
        }

        .upgrade-item, .task-item {
            background: rgba(10, 20, 35, 0.55);
            border-radius: 0.9rem;
            padding: 0.6rem 0.4rem;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid rgba(59, 130, 246, 0.2);
            cursor: pointer;
        }

        .item-left {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            flex: 1;
        }

        .item-info {
            display: flex;
            flex-direction: column;
        }

        .item-name {
            font-weight: 600;
            font-size: 0.8rem;
        }

        .item-level {
            font-size: 0.65rem;
            color: #aaccff;
        }

        .item-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .item-button {
            background: rgba(59, 130, 246, 0.05);
            color: #aaccff;
            font-size: 0.7rem;
            padding: 0.35rem 0.7rem;
            border-radius: 1.5rem;
            border: 1px solid rgba(59, 130, 246, 0.25);
            cursor: pointer;
            text-transform: uppercase;
        }

        .admin-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #2b6ed7, #0a2a6a);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            z-index: 10000;
        }

        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(3, 7, 18, 0.95);
            backdrop-filter: blur(10px);
            z-index: 20000;
            overflow-y: auto;
            display: none;
            color: white;
            padding: 20px;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.3);
            padding-bottom: 10px;
        }

        .admin-title {
            font-size: 1.5rem;
            color: #3b82f6;
        }

        .admin-close {
            font-size: 2rem;
            cursor: pointer;
            padding: 0 10px;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-tab {
            padding: 10px 20px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            cursor: pointer;
        }

        .admin-tab.active {
            background: rgba(59, 130, 246, 0.3);
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(20, 40, 70, 0.55);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3b82f6;
        }

        .users-list {
            max-height: 500px;
            overflow-y: auto;
            background: rgba(10, 20, 35, 0.55);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 10px;
            padding: 10px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            cursor: pointer;
        }

        .user-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .user-id {
            font-weight: bold;
            color: #3b82f6;
        }

        .user-details {
            font-size: 0.8rem;
            color: rgba(170, 204, 255, 0.8);
        }

        .user-balance {
            font-weight: bold;
        }

        .floating-value {
            position: fixed;
            font-weight: 600;
            font-size: 1rem;
            color: #aaccff;
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.25);
            border-radius: 1.5rem;
            padding: 0.2rem 0.7rem;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            z-index: 9999;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.8); }
            100% { opacity: 0; transform: translate(-50%, -50%) translateY(-80px) scale(1.1); }
        }

        .notice {
            text-align: center;
            font-size: 0.65rem;
            color: #aaccff;
            margin-top: 1rem;
            border-top: 1px dashed rgba(59, 130, 246, 0.3);
            padding-top: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="top-bar">
            <div class="balance-box">
                <span class="balance-amount" id="balanceDisplay">10.500000</span>
                <span style="color: #aaccff; font-size: 0.7rem;">USDT</span>
            </div>
        </div>

        <div class="energy-panel">
            <div class="energy-left">
                <span class="bolt">‚ö°</span>
                <span class="energy-count" id="energyDisplay">1000</span>
            </div>
            <div class="energy-bar-bg">
                <div class="energy-bar-fill" id="energyBarFill" style="width: 100%;"></div>
            </div>
            <span class="regen-tip" id="regenTip">+1/—Å–µ–∫</span>
        </div>

        <div class="tap-zone" id="tapButton">
            <div class="big-coin">
                <span class="letter-t">T</span>
            </div>
        </div>

        <div class="tap-value" id="tapValueDisplay">0.000200 USDT –∑–∞ —Ç–∞–ø</div>

        <div class="top-ref-bar" id="topRefBar">
            <span>üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</span>
            <span style="color: #aaccff;">+500 ‚ö°</span>
        </div>

        <div class="feature-grid">
            <div class="feature-card" id="rankCard">
                <span>üèÜ –†–∞–Ω–≥</span>
                <span>–ë—Ä–æ–Ω–∑–∞</span>
            </div>
            <div class="feature-card" id="referralsCard">
                <span>üë• –†–µ—Ñ–µ—Ä–∞–ª—ã</span>
                <span id="refCount">0</span>
            </div>
        </div>

        <div class="upgrade-section">
            <div class="section-header">
                <span>‚ö° –£–ª—É—á—à–µ–Ω–∏—è</span>
            </div>
            
            <div class="upgrade-item" id="upgradeDamage">
                <div class="item-left">
                    <div class="item-info">
                        <span class="item-name">–£—Ä–æ–Ω –∑–∞ –∫–ª–∏–∫</span>
                        <span class="item-level" id="damageLevel">—É—Ä. 1</span>
                    </div>
                </div>
                <div class="item-right">
                    <span class="item-value" id="damageValue">1.0x</span>
                    <button class="item-button upgrade-btn" data-type="damage">–£–ª—É—á—à–∏—Ç—å</button>
                </div>
            </div>
            
            <div class="upgrade-item" id="upgradeCapacity">
                <div class="item-left">
                    <div class="item-info">
                        <span class="item-name">–Å–º–∫–æ—Å—Ç—å —ç–Ω–µ—Ä–≥–∏–∏</span>
                        <span class="item-level" id="capacityLevel">—É—Ä. 1</span>
                    </div>
                </div>
                <div class="item-right">
                    <span class="item-value" id="capacityValue">1000</span>
                    <button class="item-button upgrade-btn" data-type="capacity">–£–ª—É—á—à–∏—Ç—å</button>
                </div>
            </div>
            
            <div class="upgrade-item" id="upgradeRecovery">
                <div class="item-left">
                    <div class="item-info">
                        <span class="item-name">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</span>
                        <span class="item-level" id="recoveryLevel">—É—Ä. 1</span>
                    </div>
                </div>
                <div class="item-right">
                    <span class="item-value" id="recoveryValue">1/—Å–µ–∫</span>
                    <button class="item-button upgrade-btn" data-type="recovery">–£–ª—É—á—à–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="tasks-section">
            <div class="section-header">
                <span>üìã –ó–∞–¥–∞–Ω–∏—è</span>
            </div>
            
            <div class="task-item" id="taskSubscribe">
                <span>üì∫ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª</span>
                <div class="item-right">
                    <span class="task-reward">+0.80 USDT</span>
                    <button class="item-button task-btn" data-task="subscribe">–°—Ç–∞—Ä—Ç</button>
                </div>
            </div>
            
            <div class="task-item" id="taskAd">
                <span>üìπ –°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–ª–∞–º—É</span>
                <div class="item-right">
                    <span class="task-reward">+0.20 USDT</span>
                    <button class="item-button task-btn" data-task="ad">–°—Ç–∞—Ä—Ç</button>
                </div>
            </div>
            
            <div class="task-item" id="taskWallet">
                <span>üí≥ –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–æ—à–µ–ª—ë–∫</span>
                <div class="item-right">
                    <span class="task-reward">+22.50 USDT</span>
                    <button class="item-button task-btn" data-task="wallet">–°—Ç–∞—Ä—Ç</button>
                </div>
            </div>
        </div>

        <div class="notice">
            ‚ö° Trust Wallet ¬∑ Tap to earn
        </div>
    </div>

    <div class="admin-btn" id="adminBtn">A</div>

    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <span class="admin-title">üîê –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</span>
            <span class="admin-close" id="adminClose">√ó</span>
        </div>

        <div class="admin-tabs">
            <div class="admin-tab active" data-tab="stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            <div class="admin-tab" data-tab="users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
            <div class="admin-tab" data-tab="referrals">üîó –†–µ—Ñ–µ—Ä–∞–ª—ã</div>
            <div class="admin-tab" data-tab="tools">üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
        </div>

        <div class="admin-tab-content active" id="tab-stats">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeToday">0</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalBalance">0</div>
                    <div class="stat-label">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTaps">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —Ç–∞–ø–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalReferrals">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
                </div>
            </div>
        </div>

        <div class="admin-tab-content" id="tab-users">
            <div style="margin-bottom: 10px;">
                <input type="text" id="userSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –∏–º–µ–Ω–∏..." style="width: 100%; padding: 10px; background: rgba(10,20,35,0.8); border: 1px solid rgba(59,130,246,0.3); border-radius: 10px; color: white;">
            </div>
            <div class="users-list" id="usersList"></div>
        </div>

        <div class="admin-tab-content" id="tab-referrals">
            <div style="margin-bottom: 10px;">
                <select id="referralUserSelect" style="width: 100%; padding: 10px; background: rgba(10,20,35,0.8); border: 1px solid rgba(59,130,246,0.3); border-radius: 10px; color: white;">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                </select>
            </div>
            <div class="users-list" id="referralTree"></div>
        </div>

        <div class="admin-tab-content" id="tab-tools">
            <div style="display: flex; gap: 10px; flex-direction: column;">
                <button class="item-button" onclick="DB.clearAll()" style="padding: 15px; background: #ef4444;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
                <button class="item-button" onclick="exportData()" style="padding: 15px; background: #10b981;">üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
                <button class="item-button" onclick="importData()" style="padding: 15px; background: #3b82f6;">üì§ –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
                <button class="item-button" onclick="createTestUser()" style="padding: 15px; background: #f59e0b;">üß™ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            </div>
        </div>
    </div>

    <script>
        // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –∏–≥—Ä—ã
        (function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
            if (!window.DB) {
                console.error('‚ùå Database module not loaded!');
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!');
                return;
            }

            console.log('üéÆ Game initializing...');

            // Telegram WebApp initialization
            if (window.Telegram?.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                tg.disableVerticalSwipes();
            }

            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
            function getReferrerFromUrl() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const startParam = urlParams.get('start');
                    if (startParam) {
                        console.log('‚úÖ Found start parameter:', startParam);
                        return startParam;
                    }
                } catch (e) {
                    console.error('Error parsing URL:', e);
                }
                return null;
            }

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
            let userData = {
                userId: 'guest_' + Date.now(),
                userName: 'Guest',
                userUsername: ''
            };

            if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                const user = window.Telegram.WebApp.initDataUnsafe.user;
                userData = {
                    userId: user.id.toString(),
                    userName: user.first_name + (user.last_name ? ' ' + user.last_name : ''),
                    userUsername: user.username || ''
                };
            }

            const referrerId = getReferrerFromUrl();
            
            console.log('üì± User:', userData);
            console.log('üîó Referrer:', referrerId);

            // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —ç–∫–æ–Ω–æ–º–∏–∫–∏
            const ECONOMY = {
                baseTapValue: 0.0002,
                baseCapacity: 1000,
                baseRecovery: 1,
                tapCost: 1,
                upgrades: {
                    damage: [1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 6.0],
                    capacity: [1.0, 1.3, 1.6, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0],
                    recovery: [1.0, 1.3, 1.6, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0]
                },
                upgradePrices: {
                    damage: [2.5, 5, 10, 20, 40, 80, 160, 320, 640, 1280],
                    capacity: [3, 6, 12, 24, 48, 96, 192, 384, 768, 1536],
                    recovery: [1.5, 3, 6, 12, 24, 48, 96, 192, 384, 768]
                },
                rewards: {
                    subscription: 0.80,
                    ad: 0.20,
                    wallet: 22.50,
                    referral: 500
                }
            };

            // –¢–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫
            let player = null;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∏–≥—Ä–æ–∫–∞
            function loadPlayer() {
                const existingUser = DB.getUser(userData.userId);
                
                if (existingUser) {
                    player = existingUser;
                    console.log('‚úÖ Player loaded from DB');
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                    player = {
                        userId: userData.userId,
                        userName: userData.userName,
                        userUsername: userData.userUsername,
                        balance: 10.5,
                        damageLevel: 1,
                        capacityLevel: 1,
                        recoveryLevel: 1,
                        energy: ECONOMY.baseCapacity,
                        referrals: 0,
                        referrer: referrerId || null,
                        tasks: {
                            subscribe: false,
                            ad: false,
                            wallet: false
                        },
                        totalTaps: 0,
                        lastActive: Date.now(),
                        createdAt: Date.now(),
                        referralProcessed: false
                    };
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ (—Ä–µ—Ñ–µ—Ä–∞–ª –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ DB.saveUser)
                    DB.saveUser(player);
                    
                    if (referrerId) {
                        console.log('üéâ New user from referral!');
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–Ω–µ—Ä–≥–∏—é
                const maxEnergy = getCurrentCapacity();
                if (player.energy > maxEnergy) {
                    player.energy = maxEnergy;
                }
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            function formatUSDT(value) {
                return value.toFixed(6);
            }

            function getCurrentTapValue() {
                return ECONOMY.baseTapValue * ECONOMY.upgrades.damage[player.damageLevel - 1];
            }

            function getCurrentCapacity() {
                return Math.floor(ECONOMY.baseCapacity * ECONOMY.upgrades.capacity[player.capacityLevel - 1]);
            }

            function getCurrentRecovery() {
                return ECONOMY.baseRecovery * ECONOMY.upgrades.recovery[player.recoveryLevel - 1];
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            function updateUI() {
                document.getElementById('balanceDisplay').textContent = formatUSDT(player.balance);
                
                const maxEnergy = getCurrentCapacity();
                document.getElementById('energyDisplay').textContent = Math.floor(player.energy);
                document.getElementById('energyBarFill').style.width = `${(player.energy / maxEnergy) * 100}%`;
                document.getElementById('regenTip').textContent = `+${getCurrentRecovery().toFixed(1)}/—Å–µ–∫`;
                
                document.getElementById('tapValueDisplay').textContent = `${getCurrentTapValue().toFixed(6)} USDT –∑–∞ —Ç–∞–ø`;
                document.getElementById('refCount').textContent = player.referrals;
                
                document.getElementById('damageValue').textContent = `${ECONOMY.upgrades.damage[player.damageLevel-1].toFixed(1)}x`;
                document.getElementById('damageLevel').textContent = `—É—Ä. ${player.damageLevel}`;
                document.getElementById('capacityValue').textContent = getCurrentCapacity();
                document.getElementById('capacityLevel').textContent = `—É—Ä. ${player.capacityLevel}`;
                document.getElementById('recoveryValue').textContent = `${getCurrentRecovery().toFixed(1)}/—Å–µ–∫`;
                document.getElementById('recoveryLevel').textContent = `—É—Ä. ${player.recoveryLevel}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∑–∞–¥–∞–Ω–∏–π
                const subscribeBtn = document.querySelector('[data-task="subscribe"]');
                const adBtn = document.querySelector('[data-task="ad"]');
                const walletBtn = document.querySelector('[data-task="wallet"]');
                
                if (subscribeBtn) subscribeBtn.textContent = player.tasks.subscribe ? '‚úÖ' : '–°—Ç–∞—Ä—Ç';
                if (adBtn) adBtn.textContent = player.tasks.ad ? '‚úÖ' : '–°—Ç–∞—Ä—Ç';
                if (walletBtn) walletBtn.textContent = player.tasks.wallet ? '‚úÖ' : '–°—Ç–∞—Ä—Ç';
            }

            // –ê–Ω–∏–º–∞—Ü–∏—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞
            function showFloating(text, x, y) {
                const div = document.createElement('div');
                div.className = 'floating-value';
                div.textContent = text;
                div.style.left = x + 'px';
                div.style.top = y + 'px';
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 800);
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–ø–∞
            function processTap(clientX, clientY) {
                if (player.energy < ECONOMY.tapCost) {
                    showFloating('‚ö°', clientX, clientY);
                    return;
                }
                
                const tapValue = getCurrentTapValue();
                player.energy -= ECONOMY.tapCost;
                player.balance = Number((player.balance + tapValue).toFixed(6));
                player.totalTaps++;
                
                showFloating(`+${tapValue.toFixed(4)}`, clientX, clientY);
                
                // –í–∏–±—Ä–æ
                try {
                    if (window.Telegram?.WebApp?.HapticFeedback) {
                        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    } else if (navigator.vibrate) {
                        navigator.vibrate(10);
                    }
                } catch(e) {}
                
                updateUI();
                DB.saveUser(player);
            }

            // –ü–æ–∫—É–ø–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è
            function purchaseUpgrade(type) {
                const currentLevel = player[`${type}Level`];
                if (currentLevel >= 10) {
                    alert('‚ùå –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å');
                    return;
                }
                
                const price = ECONOMY.upgradePrices[type][currentLevel - 1];
                if (player.balance < price) {
                    alert(`‚ùå –ù—É–∂–Ω–æ –µ—â–µ ${(price - player.balance).toFixed(2)} USDT`);
                    return;
                }
                
                if (confirm(`–£–ª—É—á—à–∏—Ç—å –∑–∞ ${price.toFixed(2)} USDT?`)) {
                    player.balance = Number((player.balance - price).toFixed(6));
                    player[`${type}Level`]++;
                    if (type === 'capacity') {
                        player.energy = getCurrentCapacity();
                    }
                    updateUI();
                    DB.saveUser(player);
                }
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–¥–∞–Ω–∏–π
            function handleTaskSubscribe() {
                if (player.tasks.subscribe) {
                    alert('‚ùå –ó–∞–¥–∞–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
                    return;
                }
                player.balance += ECONOMY.rewards.subscription;
                player.tasks.subscribe = true;
                updateUI();
                DB.saveUser(player);
                alert('‚úÖ +0.80 USDT');
            }

            function handleTaskAd() {
                if (player.tasks.ad) {
                    alert('‚ùå –ó–∞–¥–∞–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
                    return;
                }
                player.balance += ECONOMY.rewards.ad;
                player.tasks.ad = true;
                updateUI();
                DB.saveUser(player);
                alert('‚úÖ +0.20 USDT');
            }

            function handleTaskWallet() {
                if (player.tasks.wallet) {
                    alert('‚ùå –ó–∞–¥–∞–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
                    return;
                }
                player.balance += ECONOMY.rewards.wallet;
                player.tasks.wallet = true;
                updateUI();
                DB.saveUser(player);
                alert('‚úÖ +22.50 USDT');
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
            function initAdminPanel() {
                const ADMIN_IDS = ['7734938819']; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π ID
                const isAdmin = ADMIN_IDS.includes(userData.userId);
                
                const adminBtn = document.getElementById('adminBtn');
                const adminPanel = document.getElementById('adminPanel');
                const adminClose = document.getElementById('adminClose');
                
                if (!isAdmin) {
                    adminBtn.style.display = 'none';
                    return;
                }
                
                adminBtn.style.display = 'flex';
                
                adminBtn.addEventListener('click', () => {
                    adminPanel.classList.add('active');
                    updateAdminUI();
                });
                
                adminClose.addEventListener('click', () => {
                    adminPanel.classList.remove('active');
                });
                
                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
                        
                        tab.classList.add('active');
                        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                        
                        if (tab.dataset.tab === 'users') updateUsersList();
                        if (tab.dataset.tab === 'referrals') updateReferralsSelect();
                    });
                });
                
                // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                document.getElementById('userSearch').addEventListener('input', () => {
                    updateUsersList();
                });
                
                // –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                document.getElementById('referralUserSelect').addEventListener('change', (e) => {
                    if (e.target.value) {
                        showReferralTree(e.target.value);
                    }
                });
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
            function updateAdminUI() {
                const stats = DB.getStats();
                
                document.getElementById('totalUsers').textContent = stats.totalUsers;
                document.getElementById('activeToday').textContent = stats.activeToday;
                document.getElementById('totalBalance').textContent = stats.totalBalance.toFixed(2);
                document.getElementById('totalTaps').textContent = stats.totalTaps;
                document.getElementById('totalReferrals').textContent = stats.totalReferrals;
                
                updateUsersList();
                updateReferralsSelect();
            }

            function updateUsersList() {
                const users = DB.getAllUsers();
                const searchTerm = document.getElementById('userSearch').value.toLowerCase();
                const list = document.getElementById('usersList');
                
                list.innerHTML = '';
                
                Object.entries(users).forEach(([id, user]) => {
                    if (searchTerm && !id.includes(searchTerm) && !user.userName?.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                    
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.innerHTML = `
                        <div>
                            <div class="user-id">${id}</div>
                            <div class="user-details">${user.userName || 'Unknown'}</div>
                        </div>
                        <div class="user-balance">${user.balance?.toFixed(2) || 0} USDT</div>
                    `;
                    div.onclick = () => showUserDetails(user);
                    list.appendChild(div);
                });
            }

            function updateReferralsSelect() {
                const users = DB.getAllUsers();
                const select = document.getElementById('referralUserSelect');
                
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>';
                
                Object.entries(users).forEach(([id, user]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${id} - ${user.userName || 'Unknown'} (—Ä–µ—Ñ: ${user.referrals || 0})`;
                    select.appendChild(option);
                });
            }

            function showReferralTree(userId) {
                const referrals = DB.getUserReferrals(userId);
                const tree = document.getElementById('referralTree');
                
                if (referrals.length === 0) {
                    tree.innerHTML = '<div class="user-item">–ù–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>';
                    return;
                }
                
                let html = '';
                referrals.forEach(refId => {
                    const user = DB.getUser(refId);
                    html += `
                        <div class="user-item">
                            <div>
                                <div class="user-id">${refId}</div>
                                <div class="user-details">${user?.userName || 'Unknown'}</div>
                            </div>
                        </div>
                    `;
                });
                
                tree.innerHTML = html;
            }

            function showUserDetails(user) {
                alert(`
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.userName || 'Unknown'}
ID: ${user.userId}
üí∞ –ë–∞–ª–∞–Ω—Å: ${user.balance?.toFixed(2) || 0} USDT
‚ö° –≠–Ω–µ—Ä–≥–∏—è: ${user.energy || 0}
üë• –†–µ—Ñ–µ—Ä–∞–ª—ã: ${user.referrals || 0}
üîó –ü—Ä–∏–≥–ª–∞—à–µ–Ω: ${user.referrer || '–Ω–µ—Ç'}
üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${new Date(user.createdAt).toLocaleString()}
                `);
            }

            // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–¥–º–∏–Ω–∞
            window.exportData = function() {
                const data = DB.exportData();
                const blob = new Blob([data], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `trust_tap_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            window.importData = function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if (DB.importData(e.target.result)) {
                            alert('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
                            updateAdminUI();
                        } else {
                            alert('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };

            window.createTestUser = function() {
                const testUser = {
                    userId: 'test_' + Date.now(),
                    userName: 'Test User',
                    userUsername: 'test_user',
                    balance: 100,
                    damageLevel: 1,
                    capacityLevel: 1,
                    recoveryLevel: 1,
                    energy: 1000,
                    referrals: 0,
                    tasks: {subscribe: false, ad: false, wallet: false},
                    totalTaps: 0,
                    lastActive: Date.now(),
                    createdAt: Date.now()
                };
                DB.saveUser(testUser);
                alert('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω');
                updateAdminUI();
            };

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            function setupEventListeners() {
                const tapZone = document.getElementById('tapButton');
                const bigCoin = document.querySelector('.big-coin');

                tapZone.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    bigCoin.classList.add('pressed');
                    for (let touch of e.changedTouches) {
                        processTap(touch.clientX, touch.clientY);
                    }
                });

                tapZone.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    if (e.touches.length === 0) {
                        bigCoin.classList.remove('pressed');
                    }
                });

                tapZone.addEventListener('mousedown', (e) => {
                    bigCoin.classList.add('pressed');
                    processTap(e.clientX, e.clientY);
                });

                tapZone.addEventListener('mouseup', () => bigCoin.classList.remove('pressed'));
                tapZone.addEventListener('mouseleave', () => bigCoin.classList.remove('pressed'));

                // –ö–Ω–æ–ø–∫–∏ —É–ª—É—á—à–µ–Ω–∏–π
                document.querySelectorAll('.upgrade-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        purchaseUpgrade(e.target.dataset.type);
                    });
                });

                // –ö–Ω–æ–ø–∫–∏ –∑–∞–¥–∞–Ω–∏–π
                document.querySelectorAll('.task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const task = e.target.dataset.task;
                        switch(task) {
                            case 'subscribe': handleTaskSubscribe(); break;
                            case 'ad': handleTaskAd(); break;
                            case 'wallet': handleTaskWallet(); break;
                        }
                    });
                });

                // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
                document.getElementById('topRefBar').addEventListener('click', () => {
                    const botUsername = 'YOUR_BOT_USERNAME'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ username –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
                    const link = `https://t.me/${botUsername}?start=${player.userId}`;
                    navigator.clipboard.writeText(link).then(() => {
                        alert('‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
                    }).catch(() => {
                        prompt('–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:', link);
                    });
                });
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
            function init() {
                console.log('üöÄ Starting game...');
                
                loadPlayer();
                updateUI();
                setupEventListeners();
                initAdminPanel();
                
                // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–∏–∏
                setInterval(() => {
                    const maxEnergy = getCurrentCapacity();
                    if (player.energy < maxEnergy) {
                        player.energy = Math.min(maxEnergy, player.energy + getCurrentRecovery());
                        updateUI();
                        DB.saveUser(player);
                    }
                }, 1000);
                
                // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                setInterval(() => {
                    DB.saveUser(player);
                }, 30000);
                
                console.log('‚úÖ Game initialized');
            }

            // –ó–∞–ø—É—Å–∫
            init();
        })();
    </script>
</body>
</html>